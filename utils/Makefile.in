#
#   mod-xslt -- Copyright (C) 2002-2008 
# 		 Carlo Contavalli 
# 		 <ccontavalli at inscatolati.net>
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
@SET_MAKE@
VPATH = @srcdir@

  # Basic directories
srcdir=@srcdir@
abs_srcdir=@abs_srcdir@
top_srcdir=@top_srcdir@
abs_top_srcdir=@abs_top_srcdir@

builddir=@builddir@
abs_builddir=@abs_builddir@
top_builddir=@top_builddir@
abs_top_builddir=@abs_top_builddir@

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
sbindir=@sbindir@
datarootdir=@datarootdir@
libexecdir=@libexecdir@

datadir=@datadir@
sysconfdir=@sysconfdir@
sharedstatedir=@sharedstatedir@
localstatedir=@localstatedir@
libdir=@libdir@
infodir=@infodir@
includedir=@includedir@
mandir=@mandir@

  # Basic commands
CC := @CC@
LD := @LD@

  # Additional parameters
LIBTOOL := @LIBTOOL@
INSTALL := @INSTALL@

  # Overrideable parameters
LIBS += @LIBS@
CFLAGS += @CFLAGS@ 
LDFLAGS += @LDFLAGS@
CPPFLAGS += @CPPFLAGS@ -I$(top_srcdir)/lib -I$(top_builddir)/lib
  
  # Specific Variables
LIB_CURRENT = @LIB_CURRENT@
LIB_REVISION = @LIB_REVISION@
LIB_AGE = @LIB_AGE@
LIB_VERSION = @LIB_VERSION@

default: @DEFAULT_TARGET@

.PHONY: default all debug std clean distclean tidy release install uninstall\
	install-modxslt-parse install-modxslt-config \
	uninstall-modxslt-parse uninstall-modxslt-config 

.SUFFIXES: .c .o .h .lo .la

all: std

debug: CFLAGS += -ggdb -Wall -O0 
debug: std

std: modxslt-parse modxslt-config modxslt-perror

#modxslt-expr: modxslt-expr.o ../lib/libmodxslt.a
#	$(CC) $(LIBS) -o $@ $^

#modxslt-table: modxslt-table.o ../lib/libmodxslt.a
#	$(CC) $(LIBS) -o $@ $^

modxslt-perror: modxslt-perror.lo Makefile
	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ modxslt-perror.lo

modxslt-parse: modxslt-parse.lo  ../lib/libmodxslt$(LIB_VERSION).la Makefile
	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ modxslt-parse.lo  ../lib/libmodxslt$(LIB_VERSION).la

../lib/libmodxslt$(LIB_VERSION).la: Makefile
	$(MAKE) -C ../lib @DEFAULT_TARGET@

  # Sed expression below was not working on FreeBSD... 
modxslt-config: modxslt-config.pre $(top_builddir)/config.status Makefile
	( sed -e '/#%{AUTOCONF_VARS}%#/'q modxslt-config.pre;  \
	  grep '^s,@' $(top_builddir)/config.status |grep -v '\$$ac_' | \
	       sed -e "s/.*@\(.*\)@,\([^,]*\),.*/_acrt_\1='\2'/" | \
	       sed -e "s/|#_!""!_#|//g"; \
	  echo '#%{AUTOCONF_VARS}%#'; \
          sed -n -e '/#%{AUTOCONF_VARS}%#/,$$p' modxslt-config.pre;) >./modxslt-config
	chmod 0755 modxslt-config

modxslt-config.pre:
	@echo "ERROR ****************************"
	@echo "* modxslt-config.pre MISSING!"
	@echo "*   This file is generated by configure."
	@echo "* Run 'configure' after you use 'make distclean'"
	@echo "* and before you run make!"
	@exit 1

.c.lo: 
	$(LIBTOOL) --mode=compile --tag=CC $(CC) $(CFLAGS) $(CPPFLAGS) -c $<

clean: 
	$(LIBTOOL) --mode=clean rm -f ./*.lo ./*.o modxslt-parse modxslt-perror
	rm -f modxslt-config 

install-strip: IFLAGS += -s
install-strip: install

install: install-modxslt-parse install-modxslt-config install-modxslt-perror

install-modxslt-perror:
	$(INSTALL) -m 0755 -d $(DESTDIR)$(bindir)/
	$(LIBTOOL) --mode=install $(INSTALL) $(IFLAGS) -m 0755 modxslt-perror \
		$(DESTDIR)$(bindir)/modxslt-perror

install-modxslt-parse:
	$(INSTALL) -m 0755 -d $(DESTDIR)$(bindir)/
	$(LIBTOOL) --mode=install $(INSTALL) $(IFLAGS) -m 0755 modxslt-parse \
		$(DESTDIR)$(bindir)/modxslt-parse

install-modxslt-config:
	$(INSTALL) -m 0755 -d $(DESTDIR)$(bindir)/
	$(INSTALL) -m 0755 modxslt-config $(DESTDIR)$(bindir)/modxslt-config

uninstall: uninstall-modxslt-parse uninstall-modxslt-config uninstall-modxslt-perror

uninstall-modxslt-parse:
	$(LIBTOOL) --mode=uninstall rm -f $(DESTDIR)$(bindir)/modxslt-parse

uninstall-modxslt-perror:
	$(LIBTOOL) --mode=uninstall rm -f $(DESTDIR)$(bindir)/modxslt-perror

uninstall-modxslt-config:
	rm -f $(DESTDIR)$(bindir)/modxslt-config

tidy: clean

distclean: clean
	rm -f modxslt-config.pre

release:
