<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>mod-xslt2 Users and Administrators Manual</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"></HEAD
><BODY
CLASS="ARTICLE"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="ARTICLE"
><DIV
CLASS="TITLEPAGE"
><H1
CLASS="TITLE"
><A
NAME="AEN2"
>mod-xslt2 Users and Administrators Manual</A
></H1
><H3
CLASS="AUTHOR"
><A
NAME="AEN4"
>Carlo Contavalli</A
></H3
><P
CLASS="PUBDATE"
>Date: 2004/02/17 02:59:38 - Revision: 1.3<BR></P
><DIV
><DIV
CLASS="ABSTRACT"
><P
></P
><A
NAME="AEN7"
></A
><P
>mod-xslt2 is a web server module able to transform xml documents
in any format using xslt stylesheets, doing what might be called
server side parsing of xml files.</P
><P
></P
></DIV
></DIV
><HR></DIV
><DIV
CLASS="TOC"
><DL
><DT
><B
>Table of Contents</B
></DT
><DT
>1. <A
HREF="#AEN9"
>License, copyright and...</A
></DT
><DT
>2. <A
HREF="#AEN18"
>Introduction</A
></DT
><DT
>3. <A
HREF="#AEN44"
>History</A
></DT
><DT
>4. <A
HREF="#AEN49"
>Installation</A
></DT
><DD
><DL
><DT
>4.1. <A
HREF="#AEN51"
>Prerequisites</A
></DT
><DD
><DL
><DT
>4.1.1. <A
HREF="#AEN63"
>Apache 1.3.x</A
></DT
><DT
>4.1.2. <A
HREF="#AEN67"
>Apache 2.{1,2}.x</A
></DT
></DL
></DD
><DT
>4.2. <A
HREF="#AEN79"
>Quick start</A
></DT
><DT
>4.3. <A
HREF="#AEN89"
>Configure parameters</A
></DT
><DD
><DL
><DT
>4.3.1. <A
HREF="#AEN93"
>Installation related parameters</A
></DT
><DT
>4.3.2. <A
HREF="#AEN117"
>Compilation related parameters</A
></DT
><DT
>4.3.3. <A
HREF="#AEN165"
>SAPI Specific configure parameters</A
></DT
></DL
></DD
></DL
></DD
><DT
>5. <A
HREF="#AEN187"
>mod-xslt2 Setup and Usage</A
></DT
><DD
><DL
><DT
>5.1. <A
HREF="#AEN189"
>Apache 1.3.x</A
></DT
><DD
><DL
><DT
>5.1.1. <A
HREF="#AEN192"
>Request life</A
></DT
><DT
>5.1.2. <A
HREF="#AEN206"
>Using the ``AddHandler'' directive</A
></DT
><DT
>5.1.3. <A
HREF="#AEN215"
>Using the XSLT directives</A
></DT
><DT
>5.1.4. <A
HREF="#AEN231"
>Mixing the two</A
></DT
><DT
>5.1.5. <A
HREF="#AEN236"
>Loading the module</A
></DT
><DT
>5.1.6. <A
HREF="#AEN240"
>mod-xslt Configuration parameters</A
></DT
><DT
>5.1.7. <A
HREF="#AEN297"
>Parameters usage examples</A
></DT
><DT
>5.1.8. <A
HREF="#AEN322"
>Logging</A
></DT
><DT
>5.1.9. <A
HREF="#AEN327"
>Increasing performance</A
></DT
><DT
>5.1.10. <A
HREF="#AEN344"
>Subrequest Issues</A
></DT
></DL
></DD
><DT
>5.2. <A
HREF="#AEN360"
>Apache 2.x.x</A
></DT
><DD
><DL
><DT
>5.2.1. <A
HREF="#AEN365"
>Configuring Apache 2.x for mod-xslt</A
></DT
><DT
>5.2.2. <A
HREF="#AEN392"
>mod-xslt Configuration parameters</A
></DT
><DT
>5.2.3. <A
HREF="#AEN426"
>Apache 2.x.x, mod-xslt and PHP4</A
></DT
></DL
></DD
></DL
></DD
><DT
>6. <A
HREF="#AEN440"
>Writing XML for mod-xslt2</A
></DT
><DD
><DL
><DT
>6.1. <A
HREF="#AEN443"
>XSLT Parameters</A
></DT
><DT
>6.2. <A
HREF="#AEN497"
>mod-xslt2 Extensions</A
></DT
><DD
><DL
><DT
>6.2.1. <A
HREF="#AEN512"
>header-set</A
></DT
><DT
>6.2.2. <A
HREF="#AEN518"
>value-of - modxslt expressions</A
></DT
><DT
>6.2.3. <A
HREF="#AEN566"
>Verifying availability of mod-xslt2 extensions</A
></DT
></DL
></DD
><DT
>6.3. <A
HREF="#AEN590"
>Setting the Content-Type (MIME type) of the parsed document</A
></DT
><DT
>6.4. <A
HREF="#AEN596"
>Choosing the stylesheet to use</A
></DT
><DD
><DL
><DT
>6.4.1. <A
HREF="#AEN607"
>xml-stylesheet and modxslt-stylesheet</A
></DT
></DL
></DD
><DT
>6.5. <A
HREF="#AEN795"
>Using external DTDs</A
></DT
><DT
>6.6. <A
HREF="#AEN802"
>Testing xml files and stylesheets from the command line</A
></DT
><DD
><DL
><DT
>6.6.1. <A
HREF="#AEN806"
>xsltproc</A
></DT
><DT
>6.6.2. <A
HREF="#AEN811"
>modxslt-parse</A
></DT
><DT
>6.6.3. <A
HREF="#AEN815"
>rxp</A
></DT
></DL
></DD
><DT
>6.7. <A
HREF="#AEN819"
>Other tools provided</A
></DT
><DD
><DL
><DT
>6.7.1. <A
HREF="#AEN821"
>modxslt-perror</A
></DT
><DT
>6.7.2. <A
HREF="#AEN826"
>modxslt-config</A
></DT
></DL
></DD
></DL
></DD
><DT
>7. <A
HREF="#AEN830"
>Security considerations</A
></DT
><DD
><DL
><DT
>7.1. <A
HREF="#AEN833"
>Variables substitution</A
></DT
><DT
>7.2. <A
HREF="#AEN842"
>Avoiding deadlocks under heavy loads</A
></DT
><DT
>7.3. <A
HREF="#AEN853"
>Avoiding remote URLs in substitutions</A
></DT
></DL
></DD
><DT
>8. <A
HREF="#AEN870"
>Reporting BUGS / Helping out the project</A
></DT
></DL
></DIV
><DIV
CLASS="SECT1"
><H2
CLASS="SECT1"
><A
NAME="AEN9"
>1. License, copyright and...</A
></H2
><P
>This document was written by Carlo Contavalli &lt;ccontavalli at inscatolati.net&gt; 
and is thus Copyright (C) Carlo Contavalli 2002-2008.</P
><P
>Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.1 or
any later version published by the Free Software Foundation; with no
Invariant Sections, no Front-Cover Texts and no Back-Cover Texts.</P
><P
>Any example of program code available in this document should be
considered protected by the terms of the GNU General Public License.</P
><P
>mod-xslt2, the software described in this document, is free software; you
can redistribute it and/or modify it under the terms of the GNU 
General Public License as published by the Free Software Foundation; either
version 2 of the License, or (at your option) any later version.</P
><P
>mod-xslt2 is distributed in the
hope that it will be useful, but WITHOUT ANY WARRANTY; without even
the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR 
PURPOSE. See the GNU General Public License for more details.</P
><P
>You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</P
><P
>Trademarks are owned by their respective owners.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="AEN18"
>2. Introduction</A
></H2
><P
>Nowdays, most of the browsers on the market <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>do not</I
></SPAN
> support parsing xml
files and are not able to correctly apply xslt stylesheets.</P
><P
>Even worse, some browsers are not standard complaiant and do not follow the 
specifications closely, leading to a world where xml can
hardly be used in web applications.</P
><P
>mod-xslt2 is a server side module able to transform
``xml'' documents in ``html'' (or to any other format) before they even 
get back to the browser.</P
><P
>At time of writing, this module can be used with apache 1.3.x (stable) and 
apache 2.{1,2}.x (stable), but other web servers may get supported in the future.</P
><P
>mod-xslt2 main features include:

<P
></P
><UL
><LI
><P
>the ability to parse generated xml (ability to parse the output of php or perl scripts).</P
></LI
><LI
><P
>the ability to use the ``xslt'' indicated by the &lt;?xml-stylesheet processing
instruction.</P
></LI
><LI
><P
>the ability to send back the xml file unparsed to the browser.</P
></LI
><LI
><P
>the ability to fetch xslt or DTDs from scripts rather than from static
files.</P
></LI
><LI
><P
>the ability to fetch a different xslt depending on the content of the
request headers, of the get parameters or the web server environment.</P
></LI
><LI
><P
>the ability to allow xslt stylesheets to make use of these variables to
generate output.</P
></LI
></UL
>

This module is almost a complete rewrite of the original ``mod-xslt'' 
written by Philipp Dunkel, containing many improvements, a more generic 
API, a whole set of new and flexible features and the correction of some 
bugs that were found in the original sources.</P
><P
> 
As an effect of a more generic API, this version of mod-xslt2 supports 
both apache 1 and apache 2, while work is under way to provide a cgi and 
proxy wrapper to allow mod-xslt2 to be used on any other server.</P
><P
>The more generic API should also be usable to provide support for servers
like IIS or others, even if I'm personally not going to write code for 
closed source products.</P
><P
>The build system has also been completely rewritten and a whole set of new 
documentation included in the original package.</P
><P
>Keep also in mind that I'm not native english, and as though I'm trying to 
do my best, <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>please</I
></SPAN
> report any error or ``strange'' sentence you
may find in this (or any other) document provided with mod-xslt2.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="AEN44"
>3. History</A
></H2
><P
>It all started a rainy day when I decided to try writing some
xml pages to put on my web server. I started looking on google
to find some way to let apache parse the pages, and a whole
bounce of projects came up. I started downloading
.tar.gz, compiling, and testing them out... however, I couldn't
find anything that suit all my needs: one didn't process pi
instructions at all, the other one was not able to read 
xml to be parsed from php or cgi scripts, another one was
not able to load dtds nor to fetch xslt from http urls.</P
><P
>The situation was sad: there were tens of mod xslt available
but none of them had even a subset of ``standard'' features,
many add constraints like ``you cannot use php xml handling
functions, since they use the same xml library as php'',
and many others were just buggy and almost completely 
unmaintained. So, I took the most promising one, mod-xslt, 
written by Philipp Dunkel, and started adding
all the features I needed. However, at the time mod-xslt
run only on apache2, which was still quite buggy to my eyes.</P
><P
>So, I ended up almost completely rewriting mod-xslt (just
a few lines are still there..) and adding a whole bounce of
new features.</P
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="AEN49"
>4. Installation</A
></H2
><DIV
CLASS="SECT2"
><H3
CLASS="SECT2"
><A
NAME="AEN51"
>4.1. Prerequisites</A
></H3
><P
>To install this module, you must:

<P
></P
><OL
TYPE="1"
><LI
><P
>Make sure ``libxml2'' and ``libxslt'' and their headers (libxml2-dev and libxslt-dev)
are correctly installed on your system, and that the commands
``xslt-config'' and ``xml2-config'' can be found in your path.</P
></LI
><LI
><P
>Make sure you have a version of ``libxslt'' above 1.0.30.</P
></LI
><LI
><P
>Make sure ``libpcre'' (at least version 4.5) and its headers 
(libpcre-dev) are correctly installed on your system and that 
the command ``pcre-config'' can be found in your path.</P
></LI
><LI
><P
>Make sure to have a version of Make from the GNU project, often
known as ``gmake'' on many systems. If your system does provide
a ``gmake'' command, use that instead of ``make'' in all the 
provided examples.</P
></LI
></OL
>

You may also consider recompiling libxml2 or libxslt after applying some of the
patches provided in the ``patches/'' directory in mod-xslt2 sources. For further
information about the available patches, please read the file ``README.Patches''.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN63"
>4.1.1. Apache 1.3.x</A
></H4
><P
>To install mod-xslt2 on apache 1.3.x, you need to have the apache
headers installed (apache-dev) and the command ``apxs'' available.</P
><P
>You also need to know the path of ``apxs'', which can be found by
running something like ``locate apxs'', ``whereis apxs'' or 
``find / -name apxs''.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN67"
>4.1.2. Apache 2.{1,2}.x</A
></H4
><P
>To install mod-xslt2 on an apache 2.1.x or 2.2.x server, you need to have:

<P
></P
><UL
><LI
><P
>the apache headers file installed (apache2-dev)</P
></LI
><LI
><P
>the command ``apxs'' or ``apxs2'' available somewhere on your system
(you can find it by running ``locate apxs'', ``whereis apxs'' or 
``find / -name apxs'')</P
></LI
><LI
><P
>``libapr'' and its headers installed somewhere on your system (libapr0,
libapr0-dev) and the command ``apr-config'' (the presence of this command
usually implies the availability of the library)</P
></LI
><LI
><P
>libaprutil and its headers installed somewhere on your system (libaprutil,
libaprutil-dev) and the command ``apu-config'' (the presence of this command
usually implies the availability of the library)</P
></LI
></UL
>&#13;</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN79"
>4.2. Quick start</A
></H3
><P
>From your shell, run as a normal user:

<PRE
CLASS="SCREEN"
>  $ gzip -cd mod-xslt2*|tar x
  $ cd mod-xslt2*
  $ mkdir build
  $ cd build
  $ ../configure --with-sapi=apache1</PRE
>

Where ``apache1'' is the name of the web server
you want mod-xslt2 to be compiled for. In place
of apache1, at time of writing, you can specify
apache2 or none. If you specify ``none'' you
will get the library and the utilities that 
constitute most of mod-xslt2 compiled and 
installed.</P
><P
>If you do not specify any ``--with-sapi'' 
option, configure will try to figure out which
web server is installed on your system.
However, if you have more than one web server
supported by mod-xslt2 installed, configure
will compile mod-xslt2 for the first 
detected one.</P
><P
>Configure will also try to autodetect most of the
needed parameters and will warn you about small
incompatibilities it <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>will</I
></SPAN
> find in the libraries
on your system. Sometimes it will also suggest
you to apply a particular patch to your libxml2
or libxslt. Read ``README.Patches'' to have more
information about those patches.</P
><P
>Anyway, after successful configure completion, you 
should run:

<PRE
CLASS="SCREEN"
>  $ make
  $ su root
  # make install</PRE
>

If you ever want to remove mod-xslt2, you could also
run:

<PRE
CLASS="SCREEN"
>  # make uninstall</PRE
>&#13;</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN89"
>4.3. Configure parameters</A
></H3
><P
>As any ``configure'' script, mod-xslt2 configure accepts many parameters.
Some of those parameters are always available while a few of them depend
on the ``web server'' mod-xslt2 is being compiled for and on the libraries
available on your system.</P
><P
>The following sections will discuss all the parameters accepted by configure.
However, the ``configure --help'' screen is authoritative, as this document
may get outdated.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN93"
>4.3.1. Installation related parameters</A
></H4
><P
>The following parameters can be used to choose where mod-xslt2 will 
be installed:

<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--bindir=BINDIR</I
></SPAN
> where BINDIR is the directory where you want 
the binaries (modxslt-parse, modxslt-perror, modxslt-config) to be put
during installtion</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--libdir=LIBDIR</I
></SPAN
> where LIBDIR is the directory where you want the library
(libmodxslt0) to be put during installation</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--includedir=INCLUDEDIR</I
></SPAN
> where INCLUDEDIR is the directory where you want libmodxslt
headers to be put during installation</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--mandir=MANDIR</I
></SPAN
> where MANDIR is the directory where you want the manual pages
for the above listed commands to be put during installation</P
></LI
></UL
>

Usually, the place where to put sapi specific binaries generated 
by the compilation process is automatically detected. 
In any case, the following options may influence how the 
above paths are calculated:

<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--prefix=PREFIX</I
></SPAN
> where, if no ``--mandir'' is specified, MANDIR
is calculated to be ``PREFIX/man'', while if no ``--includedir'' is specified,
INCLUDEDIR is calculated to be ``PREFIX/include''.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--exec-prefix=EPREFIX</I
></SPAN
> where, if no ``--bindir'' is specified, BINDIR
is calculated to be ``EPREFIX/bindir'', while if no ``--libdir'' is specified,
LIBDIR is calculated to be ``PREFIX/libdir''.</P
></LI
></UL
></P
><P
>Note that if you are, for example, packaging mod-xslt2 and want all the
files to be installed under a particular directory, you can use the 
DESTDIR environment variable as usual.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN117"
>4.3.2. Compilation related parameters</A
></H4
><P
>The following parameters can be used to enable/disable mod-xslt2 features
or to choose compilation parameters:

<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--enable-debug</I
></SPAN
> starting from version 1.3.9, this option
just indicates that mod-xslt should be compiled with the options -ggdb and -O0, which
means: with support for running mod-xslt under gdb, and without optimizations.
Before version 1.3.9 this parameter used to be useful to flood your web server error.log
with information regarding mod-xslt operations and inner working (it was useful for
spotting out problems). This compile time option has been superseeded by a more flexible
mechanism which allows users to choose at run time which output they want in their
own error.log.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--enable-memory</I
></SPAN
> available from version 1.3.9, this option
enables strict checking of memory allocations and frees. It is used when running regression
tests, and should not be used otherwise.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--enable-xslt-debug</I
></SPAN
> enables libxslt debugging functions. This is
useful to verify correct behavior of libxslt. Take a look to libxslt documentation for more
details.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--disable-thread</I
></SPAN
> due to lack or bad multithreading/multimodules support
in some of the libraries used by mod-xslt2, some global variables allocated in TSD have been used (do 
not complain to me). This parameter disables libmodxslt multithreading support (the usage
of a TSD to keep global variables).</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--disable-extensions</I
></SPAN
> mod-xslt2 makes available some xslt extensions,
useful for web programmers. Compiling mod-xslt2 with this parameter disables those extensions.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--enable-libxslt-hack</I
></SPAN
> libmodxslt sometimes calls error handlers with
the wrong descriptors. Enabling this option, will provide one more layer
of protection against this kind of error in libxslt (that, at time of
writing, has not been corrected by the authors). Another solution is
to patch the library to avoid the problem. Please read ``README.Patches''.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--enable-fallback-wraparound</I
></SPAN
> once you get the errors working correctly,
if you use the ``fallback'' tag, you may see strange messages flooding your
logs. This option tells mod-xslt2 to remove fallback nodes at least when used
inside mod-xslt2 extension elements, to reduce the number of those messages.
Another solution is to patch the library to avoid the problem. Please
read ``README.Patches''.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--enable-exslt</I
></SPAN
> (obsolete, available only for mod-xslt &lt; 1.3.9)
enable exslt extensions for libxslt. Default is disabled.
If you need or want to use the advanced string operators, remember to enable this option.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--disable-exslt</I
></SPAN
> (available starting with mod-xslt 1.3.9) disable 
exslt extensions for libxslt. Default is enabled.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--disable-xinclude</I
></SPAN
> disable modxslt usage of xinclude. Default is enabled.
If you want to disable xinclude or maintain backward compatibility, you are free to disable xinclude.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--with-sapi=apache1|apache2|none</I
></SPAN
> allows you to specify for which web server (sapi) 
to compile mod-xslt2. Currently, you can specify ``apache1'' for apache version 1.3.x,
``apache2'' for apache version &gt; 2.x.44, ``apache'' to enable apache
version autodetection or ``none'' to compile only mod-xslt2 utilities and libraries. 
More sapi modules are currently being developed.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--with-xml2-config=path</I
></SPAN
> allows you to specify where the libxml2 
``xml2-config'' script is located. If not specifyed, the first one found in the search path will be
used. As an example, you could specify something like:
``--with-xml2-config=/usr/local/libxml2-2.5.57/bin/xml2-config''</P
><P
>If you don't have xml2-config on your system, you probably haven't installed
libxml2 correctly or you haven't installed the ``-dev'' version of the
packages (rpm &amp; deb). If you don't know where it is, you can run ``locate xml2-config'' or
``find / -name xml2-config'' to locate it.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--with-xslt-config=path</I
></SPAN
> allows you to specify where the ``xslt-config'' script
is located. If not specifyed, the first one found in the search path will be
used.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--with-pcre-config=path</I
></SPAN
> allows you to specify where the ``pcre-config'' script
is located. If not specifyed, the first one found in the search path will be
used. If not found, support for ``Perl Compatible Regular Expressions'' will
be <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>disabled</I
></SPAN
>.</P
></LI
></UL
>&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN165"
>4.3.3. SAPI Specific configure parameters</A
></H4
><DIV
CLASS="SECT4"
><H5
CLASS="SECT4"
><A
NAME="AEN167"
>4.3.3.1. Apache 1</A
></H5
><P
>&#13;<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--with-apxs</I
></SPAN
> allows you to specify the ``apxs'' that should be used.
By default, the first ``apxs'' found in the ``PATH'' or in ``/usr/bin'',
``/usr/local/bin'', ``/usr/local/apache/bin'' is used. If you have
no apxs on your system, you probably don't have apache headers (or the
package apache-dev) installed correctly.</P
></LI
></UL
>
Note that running ``make install'' will install mod-xslt2 in the path returned
by the ``apxs'' found (``apxs -q LIBEXECDIR''), eventually prefixed by the 
DESTDIR environment variabe as usual.</P
></DIV
><DIV
CLASS="SECT4"
><HR><H5
CLASS="SECT4"
><A
NAME="AEN174"
>4.3.3.2. Apache 2.x.x</A
></H5
><P
>&#13;<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--with-apxs</I
></SPAN
> allows you to specify the ``apxs'' that should be used.
By default, the first ``apxs'' found in the ``PATH'' or in ``/usr/bin'',
``/usr/local/bin'', ``/usr/local/apache/bin'' is used. If you have
no apxs on your system, you probably don't have apache headers (or the
package apache-dev) installed correctly.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--with-apr-config</I
></SPAN
> allows you to specify the ``apr-config'' script that
should be used. By default, the first ``apr-config'' found is used.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>--with-apu-config</I
></SPAN
> allows you to specify the ``apu-config'' script that
should be used. By default, the first ``apu-config'' found is used.</P
></LI
></UL
>

Note that running ``make install'' will install mod-xslt2 in the path returned
by the ``apxs'' found (``apxs -q LIBEXECDIR''), eventually prefixed by the 
prefix specified with ``--prefix'' to configure. </P
></DIV
></DIV
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="AEN187"
>5. mod-xslt2 Setup and Usage</A
></H2
><DIV
CLASS="SECT2"
><H3
CLASS="SECT2"
><A
NAME="AEN189"
>5.1. Apache 1.3.x</A
></H3
><P
>mod-xslt2 can be configured in several ways to be used on apache 1.3.
To choose which one suits best your needs, you need a good knowledge
of how apache works. The following sections will try to give you the basic
knowledge needed to configure mod-xslt2.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN192"
>5.1.1. Request life</A
></H4
><P
>When requesting a document to an Apache 1.3 server through your browser, apache

<P
></P
><OL
TYPE="1"
><LI
><P
>takes the requested URL and remaps it to a ``file location'', to a path
on the local file system
(as an example, ``http://www.masobit.net/foo/bar.xml'' may become 
``/opt/array-00/customers/masobit.net/http/bar.xml'')</P
></LI
><LI
><P
>tries to understand the format the document is written into (it looks for the mime type 
of the document)</P
></LI
><LI
><P
>looks for someone or something able to ``read'' the provided document type (an ``handler'')</P
></LI
><LI
><P
>the handler is passed the job to send the document ``over the 	
wire'' back to the browser. </P
></LI
></OL
>

As an example, when you request a .php file with something like ``www.masobit.net/info.php'',
on our server the first step remaps ``www.masobit.net/info.php'' in something
like ``/opt/array-00/customers/masobit.net/http/info.php''. Apache then looks in the
mime.magic or mime.types (or the AddType directives) for the mime type of the file. 
Provided the content of those files and those directives are correct, apache will decide 
the requested file is of type ``application/x-httpd-php''.</P
><P
>Apache will then look for a handler able to serve this kind of document, and it will see
that ``application/x-httpd-php'' is handled by the ``libphp4.so'' module.</P
><P
> 
Apache will then call a function in this module and let the module directly write the 
answer back to the browser.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN206"
>5.1.2. Using the ``AddHandler'' directive</A
></H4
><P
>One good way to let mod-xslt2 handle a request is to use the ``AddHandler'' or 
``SetHandler'' directive. </P
><P
>Using those directives you can tell apache you want a particular kind of file 
being handled <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>directly</I
></SPAN
> by mod-xslt2. For example, 
you could use something like:

<PRE
CLASS="SCREEN"
>  AddHandler mod-xslt .xml</PRE
>

To tell apache the handler for all xml files needs to be ``mod-xslt2''. AddHandler can
be even activated on a per directory/per location or per file basis. For example, 
you could activate xml parsing in a given directory by using something like:

<PRE
CLASS="SCREEN"
>  &lt;Directory "/opt/foo/"&gt;
    AddHandler mod-xslt .xml
  &lt;/Directory&gt;</PRE
>

If you want to parse all the files in a given directory as xml files regardless of their extension
you could use something like:

<PRE
CLASS="SCREEN"
>  &lt;Directory "/opt/foo/"&gt;
    SetHandler mod-xslt
  &lt;/Directory&gt;</PRE
>

AddHandler and SetHandler are the ``fastest'' way to use mod-xslt2. The drawback is
that <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>this method won't work if you set mod-xslt2 up to handle .php files, since they won't be 
parsed</I
></SPAN
> by the php module. Infact, as explained previously, apache will call mod-xslt2 instead
of ``libphp4.so'' to send the document back to the browser.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN215"
>5.1.3. Using the XSLT directives</A
></H4
><P
>In case you need to apply stylesheets to dynamically generated documents, you thus need 
to use the mechanism provided by mod-xslt2.</P
><P
>This mechanism has nothing to do with the mechanism described in the previous sections
and does not conflict with it. Keep in mind, however, that the following directives need
to be used <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>only if you want to parse dynamically generated files</I
></SPAN
>, like php, perl or
cgi.</P
><P
>Before anything else, you need to enable the XSLT Engine for a given directory, using
the ``XSLTEngine &lt;on|off&gt;'' directive. Once enabled, mod-xslt will be called
for <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>every</I
></SPAN
> file in the given directory that apache will 
be required to serve.</P
><P
>However, while coding the module, we had the choice to:

<P
></P
><UL
><LI
><P
>check the mime type of every apache reply, and parse it if it was of type
text/xml (note: on most systems, text/xml is application/xml...).</P
></LI
><LI
><P
>check the mime type only of <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>some</I
></SPAN
> requests, and parse them only if they
were of type text/xml.</P
></LI
></UL
>

Since checking the type of a reply is quite expensive in terms of system resources,
we decided to go with the second choice. You thus need to tell mod-xslt2 which requests
you want it to check for xml output to parse, by using the ``XSLTAddFilter'' parameter.
As an example, if you want to apply an xslt stylesheet to the output of the
php scripts in one of your directories, you need to use something like:

<PRE
CLASS="SCREEN"
>&lt;Directory 
  "/opt/array-00/customers/masobit.net/http/php-xml/"&gt;
  XSLTEngine on
  XSLTAddFilter application/x-httpd-php
&lt;/Directory&gt;</PRE
>

However, keep in mind that the output of a given script will be parsed
if and only if it outputs xml data and sets the mime type to ``text/xml'', 
so, in php, you need to use something like ``header("Content-Type: text/xml")''
before anything else in your scripts.</P
><P
>Remember: you need to use ``XSLTEngine on'' only if you need to parse 
dynamic pages. </P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN231"
>5.1.4. Mixing the two</A
></H4
><P
>As a rule of thumb, you can use ``AddHandler'' for any ``static document'' and
``XSLTEngine'' with ``XSLTAddFilter'' with any ``dynamic document''.</P
><P
>A complete example could be the following:

<PRE
CLASS="SCREEN"
>...
LoadModule mxslt_module /usr/lib/apache/modules/mod_xslt.so
AddModule modxslt.c
...

XSLTTmpDir /tmp

  # Always parse .xml files using the 
  # specified stylesheets
AddHandler mod-xslt .xml

  # In this directory, some .php scripts
  # output xml to be parsed - those 
  # scripts need to set the ``Content-Type''
  # header to text/xml if they want
  # a stylesheet to be applied. Otherwise,
  # they will be ignored
  # header("Content-Type: text/xml")

  # Note also that it is sometime useful
  # to specify application/xml instead,
  # which is the default for most systems
&lt;Directory /var/www/xml&gt;
  XSLTEngine on
  XSLTAddFilter application/x-httpd-php
&lt;/Directory&gt;</PRE
>

In the example above, only php scripts in ``/var/www/xml'' will be parsed
provided they output a Content-Type header set to ``text/xml''. If you
want to parse them regardless of the Content-Type, thus regardless of
the type of data they are outputting, you can use the apache directive
``XSLTAddForce'' with the same syntax of XSLTAddFilter.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN236"
>5.1.5. Loading the module</A
></H4
><P
>Regardless of which method you may decide to use to parse your xml
data, keep in mind you always need to tell apache to load the module.
To do so, add a line like the following to your httpd.conf:

<PRE
CLASS="SCREEN"
>LoadModule mxslt_module /usr/lib/apache/modules/mod_xslt.so
AddModule modxslt.c</PRE
>

Beware that the second parameter must be the full path were mod_xslt
got installed. Since the path is detected by querying ``apxs'', it will
probably be the same as any other apache module. If you don't know where
apache modules are kept on your system, use something like ``apxs -q LIBEXECDIR''
or look to other LoadModule directives in your configuration files.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN240"
>5.1.6. mod-xslt Configuration parameters</A
></H4
><P
>&#13;<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTEngine &lt;on|off&gt;</I
></SPAN
> per directory, per file, per virtual host or in global 
configuration file, allows you to enable or disable XSLT extra features.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTTmpDir &lt;directory&gt;</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, allows you to specify which directory mod-xslt2 will use to
create temporary files. By default, ``/tmp/mod-xslt2'' is used. Keep in mind that 
``/tmp/mod-xslt2'' must exist in your system. Path must be absolute: ``/tmp'' good,
``/var/tmp'' good, ``tmp'' <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>bad</I
></SPAN
>, ``./tmp'' <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>bad</I
></SPAN
>.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTAddFilter &lt;MimeType&gt;</I
></SPAN
> per directory, per file, per virtual host, or
in global configuration file, tells mod-xslt2 to parse files of the given 
mime type as if they were xml files. Keep in mind that the file is parsed only
if the content type is set to ``text/xml'' or ``application/xml''.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDelFilter &lt;MimeType&gt;</I
></SPAN
> per directory, per file, per virtual host, or
in global configuration file, tells mod-xslt2 not to parse files of the given mime
type anymore. This is needed since mod-xslt2 per directory configurations are hinerited
from parent directories.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTAddForce &lt;MimeType&gt;</I
></SPAN
> per directory, per file, per virtual host, or
in global configuration file, tells mod-xslt2 to parse files of the given 
mime type as if they were xml files, independently from the resulting content type.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDelForce &lt;MimeType&gt;</I
></SPAN
> per directory, per file, per virtual host, or
in global configuration file, tells mod-xslt2 not to parse files of the given mime
type anymore. This is needed since mod-xslt2 per directory configurations are hinerited
from parent directories.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTSetStylesheet &lt;MimeType&gt; &lt;Stylesheet&gt;</I
></SPAN
> per directory, per file,
per virtual host or in global configuration file, tells mod-xslt2 to use the given stylesheet
for all files of the given MimeType, independently from any ``&lt;xml-stylesheet...'' or processing
instruction available into the document. The MimeType is usually something like text/xml or application/xml,
telling all such documents need to be transformed using the specified stylesheet.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTUnSetStylesheet &lt;MimeType&gt; &lt;Stylesheet&gt;</I
></SPAN
> per directory, per file,
per virtual host or in global configuration file, tells mod-xslt2 to forget about a previous
``XSLTSetStylesheet''. This is needed since mod-xslt2 per directory configurations are hinerited from
parent directories. </P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDefaultStylesheet &lt;MimeType&gt; &lt;Stylesheet&gt;</I
></SPAN
> per directory, per file,
per virtual host or in global configuration file, tells mod-xslt2 that, in case an xml
file does not contain any ``&lt;xml-stylesheet...'' or ``&lt;xslt-stylesheet...'', for
the given MimeType the specified xslt stylesheet should be used. Same things as for XSLTSetStylesheet.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTNoDefaultStylesheet &lt;MimeType&gt;</I
></SPAN
> per directory, per file,
per virtual host or in global configuration file, tells mod-xslt2 that to forget about
a previous ``XSLTDefaultStylesheet''. This is needed since mod-xslt2 per directory configurations 
are hinerited from parent directories.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTUnlink &lt;on|off&gt;</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, tells mod-xslt2 that temporary files are not to be deleted.
This option was provided to simplify debugging of newly created documents: combined
with a per directory ``XSLTTmpDir'' and using dynamic documents provided by php or
perl, the temporary file will keep the xml document generated by your scripts, simplifying
debugging. You can find the temporary file that generated an error by reading the error
log.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTParam "variable" "value"</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, tells mod-xslt2 to pass the given ``variable'' to the stylesheet
with the indicated ``value''. Those variables are accessible from the stylesheet using the mod-xslt2 extension 
value-of, with something like: &lt;mxslt:value-of select="$MODXSLT[variable]" ... look to the variable 
substitution paragraph for more details...</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTAddRule "stylesheet" "condition"</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, tells mod-xslt2 to use the specified stylesheet if all conditions specified in ``condition'' 
are met. Any modxslt-stylesheet or xml-stylesheet contained in the document is then ignored, unless the selected stylesheet
is not loadable or does not work, in which case the rule is ignored.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDelRule "stylesheet"</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, tells mod-xslt2 to forget about the rule regarding the specified stylesheet </P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDebug category, category, category, ...</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, increases verbosity of mod-xslt2 logging. Within mod-xslt, each message is tied to one or more
categories. When XSLTDebug is specified, all messages whose categories have been specified in XSLTDebug are printed, and
usually stored in error.log. Categories are: "config" (parsing of configurations), "debug" (useful when debugging with gdb
or other tools), "flags" (causes the category of messages to be output as well), "libxml" (parsing done by libxml),
"parser" (parsing of PI and mod-xslt expressions at top of .xml files), "proto" (related to HTTP protocol, headers, and
protocol parsing), "rules" (for apache1, output debugging messages related to application of *Rules*), "sapi" (output
messages related with the interaction of the specified SAPI), "variables" (output messages regarding parsing and handling
of variables), "verbose0", "verbose1", "verbose2" (to enable outputting of messages at verbosity 0, 1, and 2), "all" to
enable all debugging messages (probably too verbose for normal usage).</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDebugMask &lt;number&gt;</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, equivalent to XSLTDebug. The only difference is that instead of specifying categories
by name, you can use an integer. The integer represents the bitwise OR of the values corresponding to each category.

Note that the integer representation of categories can change from mod-xslt version to version. You should normally
not use this parameter. Have a look into modxslt0/modxslt-debug.h, mxslt_debug_e, to see the mapping betweween
categories and parameters.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDisableSignature&lt;number&gt;</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, doesn't do anything, only for backward compatibility.</P
></LI
></UL
>&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN297"
>5.1.7. Parameters usage examples</A
></H4
><DIV
CLASS="SECT4"
><H5
CLASS="SECT4"
><A
NAME="AEN299"
>5.1.7.1. XSLTSetStylesheet</A
></H5
><P
>XSLTSetStylesheet is most useful when you have .xml documents that do not specify any
xslt stylesheet to be used for the parsing.</P
><P
>You can put all those documents in a given directory on your web server, and then use 
something like:
<PRE
CLASS="SCREEN"
>&lt;Directory /documents/without/stylesheet&gt;
  XSLTSetStylesheet default_stylesheet.xsl
&lt;/Directory&gt;</PRE
></P
><P
>All the files in /documents/without/stylesheet would then be parsed
using default_stylesheet.xsl, independently from any &lt;?xml-stylesheet
or &lt;?modxslt-stylesheet specifyed in the document.</P
><P
>XSLTSetStylesheet parameters are hierarchically propagated in subdirectories. This
means that if you want to disable one of the stylesheet you previously set, you
need to use XSLTUnSetStylesheet.</P
></DIV
><DIV
CLASS="SECT4"
><HR><H5
CLASS="SECT4"
><A
NAME="AEN306"
>5.1.7.2. XSLTAddFilter and XSLTAddForce</A
></H5
><P
>XSLTAddFilter and XSLTAddForce can be used to tell mod-xslt which files to
parse.</P
><P
>They both take as a first argument a MIME type. This MIME type is used by
mod-xslt to identify the scripts/files that may output xml to be parsed.</P
><P
>So, in order for mod-xslt to parse dynamic documents, you need to tell him 
which ``kind of documents'' may output xml.</P
><P
>Weel, those ``dynamic documents'', however, may decide not to output xml
and output something else.</P
><P
>XSLTAddFilter thus tells mod-xslt to watch a given mime type, verify if
the output is xml, and only if it is, parse it into something else.</P
><P
>XSLTAddForce, instead, watches a given mime-type, and it tells mod-xslt
to parse the output in any case, even if it doesn't look like xml. This
instruction may be used if you have cgi or dynamic scripts which output
the wrong mime type.</P
></DIV
><DIV
CLASS="SECT4"
><HR><H5
CLASS="SECT4"
><A
NAME="AEN314"
>5.1.7.3. XSLTAddRule</A
></H5
><P
>XSLTAddRule has been added since mod-xslt 1.3.6, snapshot &#62;= 2004100100.
This parameter allows you to specify a stylesheet to be used for all
documents selected by the apache directive being used only if the
specified condition, written as a mod-xslt expression (see the
dedicated section), is met.</P
><P
>Rules are checked by mod-xslt in the same order as specified, and
the first one matching specifies the stylesheet to be used to 
parse the document, independently from any &lt;xml-stylesheet or
&lt;modxslt-stylesheet being specified in the document.</P
><P
>Here are some examples:</P
><P
><PRE
CLASS="SCREEN"
>&lt;Directory /xml&gt;
  XSLTAddRule "local://style_mozilla.php?LANG=$GET[LANG]" 
  	"$HEADER[User-Agent] =~ '/mozilla/'"

  XSLTAddRule "local://style_printer.php?LANG=$GET[LANG]" 
  	"$GET[format] =~ '/printer/'"
&lt;/Directory&gt;</PRE
>
(above examples have been split on multiple lines for readability)
Note that the stylesheets can be of any of the supported kinds, and 
that mod-xslt performs variable substitution in the stylesheet URL.</P
><P
>Also note that in case the stylesheet contains errors or is not loadable for any reason, the rule
is ignored and parsing goes on using the stylesheets specified by the document.</P
></DIV
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN322"
>5.1.8. Logging</A
></H4
><P
>In order to process requests, mod-xslt2 needs to create temporary files. Temporary
files are used to process dynamic requests, and contain the XML that got to mod-xslt2
to be parsed. It is often useful to know which temporary file was associated with which 
request, especially if the unlinking of temporary files is disabled.</P
><P
>mod-xslt2 saves the name of the temporary file being used in a ``request note''
that can be retrieved by using something like ``%{mod-xslt-tmp}n" in the ``LogFormat'' directive,
with something like:

<PRE
CLASS="SCREEN"
>LogFormat "%v %h %l %u %t \"%r\" %&#62;s %b 
	(%{mod-xslt-tmp}n)" mxslt_format
CustomLog logs/mod-xslt2.log mxslt_format</PRE
>&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN327"
>5.1.9. Increasing performance</A
></H4
><P
>The only way in apache 1.3.x to intercept the output of other modules is
to provide a suitable file descriptor where to store data.</P
><P
>Since mod-xslt2 is part of apache itself, a pipe is impossible to use,
unless we fork apache one more time, slowing things down.</P
><P
>The simplest approach has thus been used: creating a temporary file,
let other modules write the replies in there, and then parse the temporary 
file. However, by using temporary files, we hit I/O performance issues.</P
><P
>One of the greatest performance improvements would thus be to mount
a ramdisk (either a ``shm'' or ``rd'' in linux), over the directory used
by mod-xslt2 for temporary files.</P
><P
>Other methods are under investigation and may get supported in future versions
of mod-xslt2:

<P
></P
><UL
><LI
><P
>Having an external daemon parse data, transmitted from apache through
a unix socket. This will be done after implementing the proxy module,
which is almost the same. This would also be useful to simplify cache
implementation.</P
></LI
><LI
><P
>Provide, as file descriptor, the file descriptor of /dev/null, and use
the ``callback'' provided by apache to store data in memory. In this case,
however, we would hit memory problems for big files. However, other
solutions may be used (mmapping a file? using libxml push method?
does it parse data on the fly or simply keeps the buffers for
later parsing?)</P
></LI
></UL
>

Another performance issue is due to:

<P
></P
><UL
><LI
><P
>external http or ftp connections to fetch .xsl or .dtd files</P
></LI
><LI
><P
>dns lookups to understand if a remote host is in practice
a remote host or a local one</P
></LI
></UL
>
The latest of the two problems can be solved either by using 
a faster name resolution mechanism (take a look to nsswitch.conf
or to the hosts file) or by paying some attention while writing
.xml+.xslt file and by explicitly telling mod-xslt2 when to use
local connections (will be explained later on).</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN344"
>5.1.10. Subrequest Issues</A
></H4
><P
>To avoid security and some concurrency issues (see the section about security
concerns), mod-xslt2 for apache 1 tryes
to avoid remote connections as much as possible, specially if those connections
will loop back to the localhost.</P
><P
>However, apache accepts any connection it receives on any of the addresses it
is listening on, and is thus hard to understand which connections will loop 
back to the local host.</P
><P
>By default, when mod-xslt2 starts, it tries to understand on which addresses
apache is listening on. However, when you write your apache configuration file,
you have two choices:

<P
></P
><UL
><LI
><P
>Explicitly listing all the ip addresses to listen on (using the
``Listen'' directive with something like ``Listen 127.0.0.1:80''
or by using ``BindAddress'' - which is deprecated by the apache
group)</P
></LI
><LI
><P
>Just specify one or more ports, and let apache listen on all
interfaces on all ip addresses (simply using the ``Port'' directive
without any ``Listen'', or by using one or more ``Listen'' with 
something like ``Listen 80 8080'')</P
></LI
></UL
>

In the first case, mod-xslt2 will use the ip addresses provided
with the ``Listen'' directive to detect remote connections.</P
><P
>However, if you use the ``Listen'' directive by just specifing the port(s)
to listen on or you just use the ``Port'' directive, mod-xslt2 will have
to try to understand which are all the ip addresses available on the
operating system, which is very system dependent and quite unportable.</P
><P
>At time of writing, mod-xslt2 configure script will try to detect
if the needed functions to get all the ip addresses of the operative
system are available, in which case the autodetection code is
compiled in.</P
><P
>However, if those functions are not available, mod-xslt2 will
complain any time you use the ``Port'' directive or
the ``Listen'' directive without explicitly specifing the ip
addresses to listen on, by printing in the logs something like:

<PRE
CLASS="SCREEN"
>INADDR_ANY is being used without ioctl support - 
	read mod-xslt2 README!</PRE
>

In this case, just change any ``Listen'' directive you have like
this:

<PRE
CLASS="SCREEN"
>Listen 80 8080</PRE
>

in something like

<PRE
CLASS="SCREEN"
>Listen 127.0.0.1:80 192.168.0.1:80 
	127.0.0.1:8080 192.168.0.1:8080</PRE
>

where ``127.0.0.1'' and ``192.168.0.1'' are the only ip addresses
apache will listen on. If you don't have any listen directive, just
add them. Watch out that, if you have many ip addresses to listen
on, apache performance will decrease (by listing them all instead). In this 
case, the best bet would be to improve mod-xslt2 detection code
and write some that will work on your platform. Please mail me
if you do so, or mail me if you need help in doing so. Unfortunately,
at time of writing, I have access only to ``Debian GNU/Linux'' machines,
and cannot tell if the detection code will work on any other
platform.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN360"
>5.2. Apache 2.x.x</A
></H3
><P
>Apache 2.x support is now considered stable (2.0, 2.2, ...), thanks to all
the people who provided feedbacks on mod-xslt mailing lists.</P
><P
>  At time of writing, there is only one known issue about mod-xslt and apache 2.x.x:
as a filter, it is not very easy for mod-xslt to return status pages different than
those set by the handler (like 404 or 500 pages), and while it works with most document 
types, it may not work with _all_ document types (depending on the handler providing the given type).</P
><P
>  For example, if a php4 script (where php4 is handled thanks to the php4 apache2handler
sapi) outputs invalid xml code, mod-xslt tries to tell apache2 to output a 500 error
page. However, the mod-xslt request is handled by the php4 handler and the connection is 
instead dropped. Other handlers may have similar problems. If you encounter some, please
report them to one of the mailing lists. At time of writing, I have no idea on how to correct
this problem, beshide handling error documents by myself (in mod-xslt) or patching php4
apache2handler. If anyone has suggestions, please contact me.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN365"
>5.2.1. Configuring Apache 2.x for mod-xslt</A
></H4
><P
>  To use mod-xslt with apache 2.x.x, you just need to
tell apache you want to use mod-xslt, by inserting
a line like the following in your httpd.conf (or apache.conf):
<PRE
CLASS="SCREEN"
>  LoadModule mxslt_module /usr/lib/apache2/modules/mod_xslt.so</PRE
>
  Where <TT
CLASS="FILENAME"
>/usr/lib/apache2/</TT
> is the path where all your
modules are kept. Note that on <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>most</I
></SPAN
> systems,
apache2 modules are kept in <TT
CLASS="FILENAME"
>/usr/local/libexec</TT
>, so
the correct LoadModule directive should be:
<PRE
CLASS="SCREEN"
>  LoadModule mxslt_module /usr/local/libexec/mod_xslt.so</PRE
>
  Note however that this path can be changed during apache2 configuration,
so please look to where other modules are kept, or run the command ``apxs2 -q LIBEXECDIR''
or ``apxs -q LIBEXECDIR''.</P
><P
>  If you don't know this path, just look for other ``LoadModule'' directives
  in your configuration file or run the command ``apxs2 -q LIBEXECDIR'', which
  will show you the correct path.</P
><P
>  Once you tell apache to load mod-xslt, you need to tell him for which files
you want mod-xslt to be used. To do so, you can use one of the following directives:

<P
></P
><UL
><LI
><P
>  <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>AddOutputFilter mod-xslt &lt;extension&gt;...</I
></SPAN
> 
  tells apache we want mod-xslt to parse all files with extension ``extension''.</P
></LI
><LI
><P
>  <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>AddOutputFilterByType mod-xslt &lt;mime-type&gt;...</I
></SPAN
> 
  tells apache we want mod-xslt to parse all files with the specified mime-type.
  Note that the mime-type should indicate which files we want mod-xslt to parse.
  Most common values are text/xml or application/xml, depending upon the configuration
  of your system.</P
></LI
><LI
><P
>  <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>SetOutputFilter mod-xslt</I
></SPAN
> 
  tells apache that we want all files in a given directory or location or virtual
  host to be parsed by mod-xslt.</P
></LI
></UL
>
  Watch out! Just use one of those directives. If you use more than one,
  your documents will be parsed more than once, and unless your first pass outputs
  .xml to be parsed again, an error will be signaled by mod-xslt. </P
><P
>  For example, you may enable mod-xslt in a given directory with something
  like:
  <PRE
CLASS="SCREEN"
>&lt;Directory /this/is/a/directory&gt;
  AddOutputFilterByType mod-xslt text/xml
  ...
&lt;/Directory&gt;
  </PRE
>
  Note that on most system both .xml and .xsl files are considered of 
  mime type application/xml. We often suggest to change that default
  and set the mime type of .xml files to text/xml and of .xsl files
  of text/xsl. You can usually use constructs like ``AddType text/xml .xml''
  to force a mime type of text/xml to .xml files... </P
><P
>  If you know before hand that all files in a given directory should be parsed
  using mod-xslt, you may also use something like:
  <PRE
CLASS="SCREEN"
>&lt;Directory /this/is/another/directory&gt;
  ...
  SetOutputFilter mod-xslt
&lt;/Directory&gt;
  </PRE
></P
><P
>  To have further details about the discussed parameters, please take a look
to the apache manual, http://httpd.apache.org/.</P
><P
>  It is important to note that it is possible to block mod-xslt from parsing
  a particular document by using the SetEnvIf parameter and the SetEnv family
  of configuration directives. mod-xslt will infact <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>NOT</I
></SPAN
>
  perform any transformation if the ``no-xslt'' environment variable is set.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN392"
>5.2.2. mod-xslt Configuration parameters</A
></H4
><P
>&#13;<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTSetStylesheet &lt;MimeType&gt; &lt;Stylesheet&gt;</I
></SPAN
> per directory, per file,
per virtual host or in global configuration file, tells mod-xslt2 to use the given stylesheet
for all files of the given MimeType, independently from any ``&lt;xml-stylesheet...'' or processing
instruction available into the document.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTUnSetStylesheet &lt;MimeType&gt; &lt;Stylesheet&gt;</I
></SPAN
> per directory, per file,
per virtual host or in global configuration file, tells mod-xslt2 to forget about a previous
``XSLTSetStylesheet''. This is needed since mod-xslt2 per directory configurations are hinerited from
parent directories.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDefaultStylesheet &lt;MimeType&gt; &lt;Stylesheet&gt;</I
></SPAN
> per directory, per file,
per virtual host or in global configuration file, tells mod-xslt2 that, in case an xml
file does not contain any ``&lt;xml-stylesheet...'' or ``&lt;xslt-stylesheet...'', for
the given MimeType the specified xslt stylesheet should be used.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTNoDefaultStylesheet &lt;MimeType&gt;</I
></SPAN
> per directory, per file,
per virtual host or in global configuration file, tells mod-xslt2 that to forget about
a previous ``XSLTDefaultStylesheet''. This is needed since mod-xslt2 per directory configurations 
are hinerited from parent directories.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTParam "variable" "value"</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, tells mod-xslt2 to pass the given ``variable'' to the stylesheet
with the indicated ``value''. Those variables are accessible from the stylesheet using the mod-xslt2 extension 
value-of, with something like: &lt;mxslt:value-of select="$MODXSLT[variable]" ... look to the variable 
substitution paragraph for more details...</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTAddRule "stylesheet" "condition"</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, tells mod-xslt2 to use the specified stylesheet if all conditions specified in ``condition'' 
are met. Any modxslt-stylesheet or xml-stylesheet contained in the document is then ignored, unless the selected stylesheet
is not loadable or does not work, in which case the rule is ignored.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDelRule "stylesheet"</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, tells mod-xslt2 to forget about the rule regarding the specified stylesheet </P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDebug category, category, category, ...</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, tells mod-xslt2 to print (in the log files) the debugging messages corresponding to the specified categories. Note that
any given message can be part of more than one category. It will be outputted only if all the categories are to be outputted according to this
parameter. Currently defined categories are: config (parsing of configurations), debug (useful when running gdb, debugging crashes or trying to find
errors in the debug system itself), flags (if enabled, the category of the messages/mask is also outputted in integer format), libxml (parsing done by libxml),
parser (parsing of PI and mod-xslt expressions at top of .xml files), proto (related to HTTP protocol, headers, and so on), rules (for apache1, output debugging
messages related to application of *Rules*), sapi (output messages related with the interaction of the specified SAPI), variables (output messages regarding
parsing and handling of variables), verbose0, verbose1, verbose2 (to enable outputting of messages at verbosity 0, 1, and 2).</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDebugMask &lt;number&gt;</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, tells mod-xslt2 to print (in the log files) the debugging messages corresponding to the specified categories. This is exactly like
the XSLTDebug parameter, but allows to specify which messages to output as an integer. The integer represents the OR of the integer value corresponding to each
category whose output is desired. Note that internally mod-xslt maps every debug category to an int, and every category is mapped to a ``name'', as indicated
above. This parameter is useful when you either want to output all messages (specify -1 as the number) or when there is some category of messages that has not
been assigned a str name yet. Have a look into modxslt0/modxslt-debug.h, mxslt_debug_e, to see the mapping betweween categories and parameters.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>XSLTDisableSignature&lt;number&gt;</I
></SPAN
> per directory, per file, per virtual host or in
global configuration file, doesn't do anything, for backward compatibility only.</P
></LI
></UL
>&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN426"
>5.2.3. Apache 2.x.x, mod-xslt and PHP4</A
></H4
><P
>    In order to use php4 with apache2, you can compile it using
    two different SAPI:
    <P
></P
><UL
><LI
><P
>        <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>apache2filter</I
></SPAN
> - where php4 is
	  used as an Apache 2.x.x FILTER
      </P
></LI
><LI
><P
>        <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>apache2handler</I
></SPAN
> - where php4 is
	  used as an Apache 2.x.x HANDLER
      </P
></LI
></UL
>
  </P
><P
>    To know more about the differences between HANDLERs and FILTERs in
    apache 2.x.x, please refer to apache 2.0.x documentation.
  </P
><P
>    To know more about how to compile php4 using the two SAPI or about
    the differences between the two, please refer to php4 documentation.
  </P
><P
>    At time of writing, however, if you compile php4 to run under apache2
    it will be compiled using the HANDLER sapi.
  </P
><P
>    mod-xslt is now being tested using only this SAPI, and only very
    old versions of mod-xslt have been tested with the FILTER sapi.
  </P
></DIV
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="AEN440"
>6. Writing XML for mod-xslt2</A
></H2
><P
>Although mod-xslt2 uses standard libraries to parse xml data and transform it, 
there are few things to keep in mind while writing xml/xslt to be parsed by 
mod-xslt2.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN443"
>6.1. XSLT Parameters</A
></H3
><P
>Before anything else, you can access many mod-xslt2 parameters using the 
standard ``value-of'' xslt tag or standard XPath expressions.</P
><P
>As an example, to put the value of the version of modxslt being used in
the output generated by a stylesheet, you could use something like:

<PRE
CLASS="SCREEN"
>  # To output version of mod-xslt2
&lt;xsl:value-of select="$modxslt-version" /&gt;

  # To check interface version
&lt;xsl:if test="$modxslt-interface &amp;lt; 1"&gt;
  mod-xslt2 interface version is greater than 1!
&lt;/xsl:if&gt;</PRE
>
At time of writing, the following variables are made available to the
xslt file by mod-xslt2:

<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-interface</I
></SPAN
> - holds the interface version being used
by mod-xslt2. It is changed every time a new variable is added
to this list and every time a new element is introduced 
(see section element extensions). Variables are not
supposed to be ever removed, so you can safely assume any greater
version number is backward compatible. Current version is ``2''. 
Unless otherwise specified, variables have been introduced in
interface version 1. In version 2, the only added variable
is modxslt-conf-xinclude.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-sapi</I
></SPAN
> - name of the sapi which is now parsing
the xml document. It is usually set by the application making
use of libmodxslt0.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-name</I
></SPAN
> - name of mod-xslt2.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-handler</I
></SPAN
> - name of handler being used by mod-xslt2.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-namespace</I
></SPAN
> - URL of the namespace for mod-xslt2 extensions.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-conf-libpcre</I
></SPAN
> - has value ``true'' if mod-xslt2 was compiled with libpcre support. </P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-conf-exslt</I
></SPAN
> - has value ``true'' if mod-xslt2 was compiled with exslt support. </P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-conf-xinclude</I
></SPAN
> - introduced in interface version 2 - has value 
``true'' if mod-xslt2 was compiled with xinclude support. </P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-conf-extensions</I
></SPAN
> - has value ``true'' if mod-xslt2 was compiled to provide extension 
elements (see dedicated section)</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-conf-libxmlthreads</I
></SPAN
> - has value ``true'' if libxml supports threads.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-conf-libxslthack</I
></SPAN
> - has value ``true'' if configure was given the parameter ``--enable-libxslt-hack''</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-conf-fallbackwrap</I
></SPAN
> - has value ``true'' if configure was given the parameter ``--enable-fallback-wraparound''</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-version</I
></SPAN
> - its value is the current version of the mod-xslt2 being used (example: "1.2.3")</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-version-major</I
></SPAN
> - its value is the first digit of the version (in the example above, "1")</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-version-minor</I
></SPAN
> - its value is the second digit of the version (in the example above, "2")</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>modxslt-version-patchlevel</I
></SPAN
> - its value is the third digit of the version (in the example above, "3")</P
></LI
></UL
>
 
Variables that have value ``true'' when a feature is enabled, have 
value ``false'' when it is not.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN497"
>6.2. mod-xslt2 Extensions</A
></H3
><P
>mod-xslt2 allows you to access many other variables by providing 
custom extension tags.</P
><P
>Those extension tags are available only when you compile mod-xslt2 without
``--disable-extensions'' and if you enable them in your xsl by 
specifying something like:

<PRE
CLASS="SCREEN"
>&lt;xsl:stylesheet version="1.0" 
    extension-element-prefixes="yaslt"
    xmlns:yaslt="http://www.mod-xslt2.com/ns/1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;</PRE
>

Note the ``extension-element-prefixes'' and 
``xmlns:yaslt="http://www.mod-xslt2.com/ns/1.0" that specify that the
extensions will live in the ``yaslt:'' namespace.</P
><P
>However, enabling the extensions will allow you to use two more additional
tags:

<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>header-set</I
></SPAN
> - to set an output header. The only valid attribute
is ``name'', you can use to specify the name of the output header you
want to set.</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>value-of</I
></SPAN
> - to fetch a mod-xslt2 specific variable. The only valid
attribute is ``select''. The value of the ``select'' attribute will
be parsed as a ``mod-xslt2'' expression, which follows completely different
rules than XPath expressions.</P
></LI
></UL
>

Since those tags are provided by extensions, you need to specify the 
namespace every time you use them. In the example above, the namespace to
use would be ``yaslt:'', as specified by the ``extension-element-prefixes''
and ``xmlns'' attributes.</P
><P
>A more complete example may be the following one:

<PRE
CLASS="SCREEN"
>&lt;xsl:stylesheet version="1.0"
    extension-element-prefixes="yaslt"
    xmlns:yaslt="http://www.mod-xslt2.com/ns/1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;

  &lt;xsl:template match="faq"&gt;
    &lt;yaslt:value-of select="$HEADER[Host]" /&gt;

    &lt;yaslt:header-set name="X-Powered-by"&gt;
      &lt;xsl:value-of select="$modxslt-version" /&gt;
    &lt;/yaslt:header-set&gt;
    
  &lt;/xsl:template&gt;

&lt;/xsl:stylesheet&gt;</PRE
>&#13;</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN512"
>6.2.1. header-set</A
></H4
><P
>header-set allows you to set a value in the http headers
that will be returned back to the client. Any name
is accepted, as is any value. If ``strip-space'' (&lt;xsl:strip-space elements=...)
is active for the given element, any sequence of blank
characters or new lines is replaced by a single space. 
This feature allows you to specify multi-line headers
(probably invalid for the http protocol) while keeping
everything working. Note that header-set won't try 
to prevent you from doing stupid things. That's up
to you. The only thing you won't be able to do 
is to set the ``Content-Type'', which is handled
by some specific code.</P
><P
>Anyway, ``header-set'' requires just the ``name'' 
attribute to be specified, to select which header
you want to set. Between the opening ``header-set''
and the closing ``/header-set'', you can use any
any element you want, just watch out for new lines and strange
characters that may invalidate your headers.</P
><P
>The following are all valid usage examples
of ``header-set'':

<PRE
CLASS="SCREEN"
>&lt;xsl:stylesheet version="1.0" 
    extension-element-prefixes="yaslt"
    xmlns:yaslt="http://www.mod-xslt2.com/ns/1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;

  [...]
    &lt;yaslt:header-set name="X-Powered-by"&gt;
      &lt;xsl:value-of select="$modxslt-version" /&gt;
    &lt;/yaslt:header-set&gt;

    &lt;yaslt:header-set name="X-Fuffa"&gt;
      fuffa
    &lt;/yaslt:header-set&gt;
    &lt;yaslt:header-set name="X-Foo"&gt;
      &lt;xsl:apply-templates /&gt;
    &lt;/yaslt:header-set&gt;
  [...]

&lt;/xsl:stylesheet&gt;</PRE
>&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN518"
>6.2.2. value-of - modxslt expressions</A
></H4
><P
>value-of allows you to fetch any mod-xslt2 specific
variable or expression.</P
><P
>While writing mod-xslt2 code, I decided to keep most of
mod-xslt2 variables in a completely independent 
and isolated namespace mainly for three reasons:

<P
></P
><UL
><LI
><P
>Some of the variables names and values are gathered
from the running environment, which, by no means, can
be considered safe or trusted.</P
></LI
><LI
><P
>For the same reason, mod-xslt2 variable names can violate XPath
specifications, and I didn't want to employ weird name
mangling routines.</P
></LI
><LI
><P
>Work is underway to cache xml and xslt meta data to speed things up.	
In order to do so, it is however necessary to intercept any access
to modxslt variables.</P
></LI
></UL
>

For the same reasons, I decided to go with my own (simple) language to
parse expressions.</P
><DIV
CLASS="SECT4"
><HR><H5
CLASS="SECT4"
><A
NAME="AEN529"
>6.2.2.1. Simple expressions</A
></H5
><P
>An expression is a list of characters which contains one or more variables.
Each variable starts with a ``$'' symbol and is followed by the name of
the variable or by the name of the variable enclosed in curly brackets 
(``{'', ``}''). The following are all valid expressions:

<PRE
CLASS="SCREEN"
>0: "this is fuffa"
1: "$fuffa"
2: "${fuffa}"
3: "this is ${fuffa}"
4: "this is much $fuffa more"</PRE
>

Expression 0 is a ``simple'' string, no replacements are done, while
expression 1 is replaced by the value of variable ``fuffa''.</P
><P
>Expression 2 is exactly like expression 1, beside the fact that using
``{'' ``}'' would allow this variable to be correctly replaced even in 
a string like ``ababa${fuffa}ababa''. Expression 3 would be replaced
by the value of variable ``$fuffa'' preceded by ``this is'', much 
like in expression 4.</P
><P
>Non existent variables are replaced by the empty string (they are removed),
while a ``$'' which should be part of the string should be escaped
by preceding it with a ``\''. This also implies that any ``\'' should
be itself escaped by using a double back slash (``\\'').</P
></DIV
><DIV
CLASS="SECT4"
><HR><H5
CLASS="SECT4"
><A
NAME="AEN535"
>6.2.2.2. Indirect references and built up variable names</A
></H5
><P
>The usage of ``${'' and ``}'' allows you to use indirect references:
let's say that ``$foo=bar'' and that ``$bar=fuffa'', evaluating
the expression ``${$foo}'' would at first be replaced by ``${bar}''
and then replaced by ``fuffa'', much like in bash programming.</P
><P
>There is more to say: inside a ``{'' and ``}'' you could even
put more than one variable or character constants, to ``build'' up
the name of the variable you want to be replaced.</P
><P
>Let's make one more example and let's say ``$fuffa=hello'', 
``$foo=fuf'' and ``$bar=fa''. In this case, we would have
the following output (given the expressions on the left):

<PRE
CLASS="SCREEN"
>${$foo$bar} -&#62; ${fuffa} -&#62; hello
${${foo}$bar} -&#62; ${fuffa} -&#62; hello
${${foo}fa} -&#62; ${fuffa} -&#62; hello
${fuf$bar} -&#62; ${fuffa} -&#62; hello</PRE
>

Using those expressions, you could have as much fun as you want
and recurse as much as you want (and your stack holds).</P
></DIV
><DIV
CLASS="SECT4"
><HR><H5
CLASS="SECT4"
><A
NAME="AEN541"
>6.2.2.3. Predefined variables (array like variables)</A
></H5
><P
>The ability of parsing variables is not such a good thing if we
don't have variables to parse. However, mod-xslt2 provides a rich set 
of predefined variables. Variables are grouped in classes that
look like ``arrays''. The main arrays available are:

<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>MODXSLT</I
></SPAN
> - holds the same variables as passed as
parameters to the xslt parser (described in
the previous sections). Those variables hold informations
like how mod-xslt2 was compiled or what features are enabled</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>GET</I
></SPAN
> - contains variables passed to your xml file
as GET parameters (http get)</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>HEADER</I
></SPAN
> - contains the headers passed to mod-xslt2
by your web server (headers that, in turn, were given
by the client)</P
></LI
></UL
>

As often happens, it is easier to explain the usage of something
by showing some examples than trying to explain how it works:

<PRE
CLASS="SCREEN"
>$GET[fuffa]
$HEADER[User-Agent]
$MODXSLT[version]
$MODXSLT[namespace]</PRE
>

In the examples above, the first line fetches the variable ``fuffa''
that was passed as a get parameter to the xml file (with something
like http://host.fqdn/file.xml?fuffa=value).</P
><P
>The second line is replaced by the header ``User-Agent'' provided
by the client, while the third and fourth lines are replaced respectively
by the value of the parameter $modxslt-version and $modxslt-namespace.</P
><P
>Using GET, you can access any ``get'' parameter that was passed to your xml 
file while HEADER gives you access to any header that was sent to you by 
the client.</P
><P
>Keep also in mind that, as explained in the previous sections, it is possible 
to build up the name of a variable from other variables. So, the following
is also valid:

<PRE
CLASS="SCREEN"
>$HEADER[$GET[header-to-check]]
${$source[User-Agent]}</PRE
>

Watch out not to insert any space between the square brackets (``['', ``]'') and the
array index, since they are not allowed and the variable won't be substituted.</P
></DIV
><DIV
CLASS="SECT4"
><HR><H5
CLASS="SECT4"
><A
NAME="AEN559"
>6.2.2.4. Setting variables</A
></H5
><P
>It is also possible to create custom variables from .xml files to be passed
over to the xslt. To do so, you need to use the Processing Instruction ``modxslt-param''
with the attributes ``name'' and ``value'', where ``name'' specifies the name of the
variable to be set while ``value'' specifies its value.</P
><P
>Using this processing instruction, you can also override the value of predefined
variables, like $GET[fuffa], but not of mod-xslt2 constants, like $MODXSLT[version].</P
><P
>However, let's see a complete example of using modxslt-param:

<PRE
CLASS="SCREEN"
>&lt;?xml version="1.0" encoding="ISO-8859-1" 
	standalone="yes"?&gt;

&lt;!DOCTYPE fuffa SYSTEM "dtd/fuffa.dtd"&gt;

&lt;?modxslt-param name="variable" value="its value" ?&gt;

[...]</PRE
>

The variable ``$variable'' would thus be accessible from your xslt
using modxslt own ``value-of'', with something like ``...:value-of select="$variable"''.</P
><P
>Note also that some SAPI allow you to pass over parameters to your
xml or xsl files from configuration files. Refer to the SAPI specific 
section of this manual.</P
></DIV
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN566"
>6.2.3. Verifying availability of mod-xslt2 extensions</A
></H4
><P
>Before using any of the mod-xslt2 xslt extensions described in the
previous sections, you should make sure they are available on your
system and version of mod-xslt2.</P
><P
>As a first test, you can verify your xslt is being used by mod-xslt2
by checking the value of the XPath param ``modxslt-interface''. If available,
you can then verify that ``modxslt-conf-extensions'' has value true, and
assume extensions are available.</P
><P
>One alternative to using mod-xslt2 params is to use the standard
functions defined in http://www.w3.org/TR/1999/REC-xslt-19991116#extensions: 

<PRE
CLASS="SCREEN"
>boolean element-available(string)
boolean function-available(string)</PRE
>

to verify mod-xslt2 extension tags are available, with something like:

<PRE
CLASS="SCREEN"
>&lt;xsl:if test="element-available('yaslt:value-of')"&gt;
  &lt;yaslt:value-of select="$HEADER[User-Agent]" /&gt;
&lt;/xsl:if&gt;</PRE
>

assuming that in the opening ``xsl:stylesheet'' tag you
specified as extension name ``yaslt''.</P
><P
>There's one more way to handle the availability of mod-xslt2
extensions: using the ``xsl:fallback'', like in this example:

<PRE
CLASS="SCREEN"
>  &lt;yaslt:value-of select="$HEADER[User-Agent]"&gt;
    &lt;xsl:fallback&gt;
      Sorry, cannot access headers 
       (no mod-xslt2 extensions available)
    &lt;/xsl:fallback&gt;
  &lt;/yaslt:value-of&gt;</PRE
>

In this case, if ``yaslt:value-of'' is not available
the xslt processor will parse the content of the ``xsl:fallback'' node.
In any other case, the ``xsl:fallback'' node will be completely
ignored.</P
><P
>However, at time of writing, libxslt-1.0.32 has a few
bugs handling fallback nodes:

<P
></P
><UL
><LI
><P
>when the extension is available, the fallback node 
is not ignored as ought to be and a warning is printed
in your web server logs (read the FAQ for more information
about this issue)</P
></LI
><LI
><P
>when the warning is printed, libxslt-1.0.32 calls the
error handler with the wrong parameters, possibly causing 
a segmentation fault (it happens if libxslt debugging
was enabled, in which case one of the pointer passed to
mod-xslt2 is not null and considered to be valid)</P
></LI
></UL
>

There are a few ways to avoid this problem:

<P
></P
><UL
><LI
><P
>patch the library in order to avoid the warning to be printed </P
></LI
><LI
><P
>patch the library in order for the correct arguments to be always passed
to error functions</P
></LI
><LI
><P
>compile mod-xslt2 specifying ``--enable-fallback-wraparound'', to
ask mod-xslt2 to remove ``fallback'' nodes when the extensions are
available</P
></LI
><LI
><P
>compile mod-xslt2 specifying ``--enable-libxslt-hack'', to ask
mod-xslt2 to always enable debugging using some wrappers, in
order to avoid the error highlighted above</P
></LI
></UL
>

Those are really two libxslt bugs, where the first one triggers the second
one. Correcting one of the two should be enough for mod-xslt2 to work. However,
the best way to solve the problem is by using the two highlighted patches.
Please read ``README.Patches'' to know more about those issues.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN590"
>6.3. Setting the Content-Type (MIME type) of the parsed document</A
></H3
><P
>As indicated in the previous sections, you are not allowed to use
``header-set'' to try to change the ``Content-Type'' of the document.</P
><P
>However, you can choose the mime type of the document by specifying the
attribute ``media-type'' in the ``xsl:output'' tag, as shown 
in the example below:

<PRE
CLASS="SCREEN"
>&lt;xsl:output media-type="text/html" 
	encoding="ISO-8859-1" /&gt;</PRE
>

If no media-type is specified, mod-xslt2 will try to guess it (relying on libxml2
parsing), probably returning back to the client a media-type of ``text/plain'', 
``text/xml'' or ``text/html''.</P
><P
>Keep in mind that you can specify any ``media-type'' you want.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN596"
>6.4. Choosing the stylesheet to use</A
></H3
><P
>mod-xslt2 decides which stylesheet to use thanks to a 3 steps procedure:

<P
></P
><OL
TYPE="1"
><LI
><P
>if any suitable &lt;?xml-stylesheet or &lt;?modxslt-stylesheet processing
instruction is found, the specified stylesheet is used, regardless of 
any XSLTSetStylesheet parameter. The first suitable xml-stylesheet 
or modxslt-stylesheet is chosen.</P
></LI
><LI
><P
>if a XSLTSetStylesheet is provided for the given document type, the
specified stylesheet is used.</P
></LI
><LI
><P
>in any other case, a 500 server error is returned (the rationale
is that once mod-xslt2 is told to parse the document, mod-xslt2 
will either output the parsed document or send an error back to
the client).</P
></LI
></OL
>

We already talked about XSLTSetStylesheet in the SAPI specific
sections, and there's not much more to say here.</P
><P
>However, as you can see in the first step, mod-xslt2 can be told 
which stylesheet to use using two different processing instructions: 
xml-stylesheet and modxslt-stylesheet.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN607"
>6.4.1. xml-stylesheet and modxslt-stylesheet</A
></H4
><P
>xml-stylesheet is a standard xml directive, and its description and
usage can be found on  http://www.w3.org/TR/xml-stylesheet. As
you probably already know, xml-stylesheet can be used to associate
a given xml file with the xslt to be used and generally looks something like:

<PRE
CLASS="SCREEN"
>&lt;?xml-stylesheet 
	type="text/xsl" 
	href="./xslt/faq-http.xsl" 
	media="screen" 
	alternate="no" 
	title="For any web browser" 
	charset="ISO-8859-1"?&gt;</PRE
>

For a given stylesheet to be considered ``suitable'' by mod-xslt2
to parse an xml file, the following conditions must be met:

<P
></P
><UL
><LI
><P
>type - must be either ``text/xml'' or 
``text/xsl''.</P
></LI
><LI
><P
>href - should contain the url of the stylesheet. 
See the next section on ``Accepted urls'' .</P
></LI
><LI
><P
>media - either ``all'' or ``screen''. 
In case of ``screen'', it can be followed
by one or more ``media expressions''. The stylesheet
will be considered ``suitable'' only if one
of the expressions is evaluated to have a ``true''
value. The ``empty'' expression
is considered to always match (be true). See the section
on ``Media expressions'' .</P
></LI
></UL
>

At time of writing, the other fields are of no interest
to mod-xslt2.</P
><P
> 
The main difference between ``xml-stylesheet'' and 
``modxslt-stylesheet'' is that the first one should
be used in a way compliant with the highlighted standards,
while the second one may use any mod-xslt2 extension.</P
><P
>Keep in mind, however, that mod-xslt2 will not complain
if you use its extensions in the standard ``xml-stylesheet''
tag.</P
><P
>modxslt-stylesheet is a processing instructions that takes
exactly the same arguments as xml-stylesheet, and it 
has been introduced mainly for three reasons:

<P
></P
><UL
><LI
><P
>As not being standardized, it is interpreted
only (and exclusively) by mod-xslt2. If a 
browser or another xslt processor finds any
modxslt-stylesheet directive, it will completely
ignore it. This allows few useful tricks that
will be discussed in the next few sections.</P
></LI
><LI
><P
>currently, the standard says that the ``media''
attribute ``may'' contain expressions, which are not
yet defined in any standard and that may be 
defined in the future (AFAIK). Browsers or 
xslt-processors are thus supposed to ignore them and 
skip anything after the first ``word'' followed by a space until
the first comma. However, mod-xslt2 supports its own 
language for expressions, language that may be used in 
``modxslt-stylesheet'' without fears to conflict
with future standards or incompatible browsers.</P
></LI
><LI
><P
>as you probably know, in case a stylesheet is
not found or is not valid, mod-xslt2 will give the user 
back a ``server error'' (the rationale is that if a document
was meant to be parsed the inability to do so is an
error). However, the ``modxslt-stylesheet'' pi provides
a simple mechanism to return back to the browser the
plain xml in order to let the browser parse it.
This feature, combined with ``media expressions'', would
allow you to configure mod-xslt2 to parse only those xml
files that would cause problems to the various browsers
on the market.</P
></LI
></UL
>

A couple examples will be given in the following sections.</P
><DIV
CLASS="SECT4"
><HR><H5
CLASS="SECT4"
><A
NAME="AEN628"
>6.4.1.1. Media expressions</A
></H5
><P
>As you probably know, the ``media'' attribute in a 
xml-stylesheet (or modxslt-stylesheet) processing 
instructions may contain a comma separated list of 
``media types'' for which the stylesheet should be used
to parse the xml data.</P
><P
>A media attribute usually looks something like:

<PRE
CLASS="SCREEN"
>&lt;xml-stylesheet ... media="screen, printer"...</PRE
>

where the media ``all'' is a sort of wildcard,
specifying that a stylesheet could be used to
parse xml data to be outputted on any media.</P
><P
>Any xslt processor should also ignore anything 
from the first space following the name of a media 
type to the first comma (or end of attribute), 
since ``in the future'' some kind of 
``expressions'' may be introduced by the standards.</P
><P
> 
Any xslt processor looking for a ``screen'' media
stylesheet, should thus accept anything like

<PRE
CLASS="SCREEN"
>&lt;xml-stylesheet media="screen fuffa fuffa, printer"
or
&lt;xml-stylesheet media="screen foo bar"</PRE
>

where ``fuffa fuffa'' or ``foo bar'' are ``Media
expressions'' that should be ignored.</P
><P
>mod-xslt2 introduces its own language to specify 
media expressions. </P
><P
>A mod-xslt2 expression is usually a boolean expression
preceded by an ``and'' made of a list of tests that must 
be passed for the stylesheet to be used. Tests may make 
use of mod-xslt2 variables and of many operators that will 
be described in the following sections.</P
><P
>Mod-xslt grammar to parse expressions could
be described by a BNF similar to the following:

<PRE
CLASS="SCREEN"
>bool_expr: 
	| cmp_expr 
	| cmp_expr ','
;

cmp_expr: '(' cmp_expr ')' 
	| '!' cmp_expr 
	| cmp_expr BooleanOperator cmp_expr 
	| String StringOperator String
	| String
;</PRE
>

Where capitalized strings are terminals and
lowercase strings are non-terminals.</P
><P
>Associativity of operators and their precedence
will be shown in the next sections.</P
><DIV
CLASS="SECT5"
><HR><H6
CLASS="SECT5"
><A
NAME="AEN641"
>6.4.1.1.1. Strings</A
></H6
><P
>A string can be specified by using the name
of a variable, a sequence of characters that
match the regular expression:

<PRE
CLASS="SCREEN"
>[^[:blank:]*+%/\"\',!&gt;&lt;=~()-]*</PRE
>

or a sequence of any character enclosed in single
or double quotes (&apos;, &quot;), where any 
``&apos;'' or ``&quot;'' part of the sequence
itself must be escaped by prepending it with a ``\'',
while a ``\'' with no special meaning should be 
escaped with another slash.</P
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/note.gif"
HSPACE="5"
ALT="Note"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Since mod-xslt2 1.3.9, escaping rules have changed.
Version preceeding (&lt;) 1.3.9 used ``\'' as a normal
escape character. Any occurrence of ``\'' followed by
any other character was replaced by the character following
without ``\'' (\a was replaced by just a). Since version
1.3.9, a ``\'' is considered <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>only</I
></SPAN
> (and only in this case!)
when followed by some sensible character, where the
only sensible character are: $, &apos; and &quot;.
For example, \a in version 1.3.9 is left as \a, while
\" is transformed into ". This change has been introduced
in order to simplify escaping of regular expressions in 
mod-xslt2 media expressions. Also note that the parsing
code has been changed, so a $ followed by an invalid
character for a variable name does not need escaping.</P
></TD
></TR
></TABLE
></DIV
><P
>Strings enclosed in single or double quotes may
also contain ``mod-xslt2 expressions'', as described
in the section  ``value-of - mod-xslt2 expressions''
and contain any of the specified variables.</P
></DIV
><DIV
CLASS="SECT5"
><HR><H6
CLASS="SECT5"
><A
NAME="AEN649"
>6.4.1.1.2. String Evaluation</A
></H6
><P
>As shown in the BNF grammar, a String can be used both
in a ``boolean'' or ``cmp'' context (either, checked
with a BooleanOperator or StringOperator). In boolean
context, a String is considered true if it does not
correspond to the empty string ("") or if the variable
is defined (has a value associated with it, regardless
of what the value is).</P
></DIV
><DIV
CLASS="SECT5"
><HR><H6
CLASS="SECT5"
><A
NAME="AEN652"
>6.4.1.1.3. Boolean Operators</A
></H6
><P
>mod-xslt2 recognizes the following left associative 
boolean operators:

<P
></P
><UL
><LI
><P
>1 - ``!'' - logical negation (left associative)</P
></LI
><LI
><P
>2 - ``and'' - logical and (left associative)</P
></LI
><LI
><P
>2 - ``or'' - logical or (left associative)</P
></LI
></UL
>

Where the precedence of the operators is determined
by the number (lower the number, higher the precedence).</P
></DIV
><DIV
CLASS="SECT5"
><HR><H6
CLASS="SECT5"
><A
NAME="AEN662"
>6.4.1.1.4. String Operators</A
></H6
><P
>mod-xslt2 recognizes the following string operators:

<P
></P
><UL
><LI
><P
>``=='' or ``='' - equal, true if the left side of the operator
is equal to the right side. At time of writing, ``='' and
``=='' have the same meaning and return a true value if
the memory representation of the string on the left
is the same of that on the right. In the future, ``=='' 
will maintain this meaning, while ``='' will be used
to compare the value of the number on the left with that
of the number on the right (taking care of roundings and
of processor precision limits).</P
></LI
><LI
><P
>``!='' - unequal, true if the left side of the operator
is not equal to the right side. By equal we mean that
the memory representation of the string on the left is 
the same as that on the right.</P
></LI
><LI
><P
>``=~'' - perl regular expression matches, true if the
regular expression on the right of the operator matches
the string on the left. See next section on regular
expressions  for more details.</P
></LI
><LI
><P
>``!~'' - perl regular expression does not match, true
if the regular expression on the right of the operator
does not match the string on the left. See next section
on regular expressions  for more details.</P
></LI
><LI
><P
>``&gt;'', ``&gt;='', ``&lt;'', ``&lt;='' - true respectively
when the string on the left of the operator, converted to
a ``real'', is greater, greater or equal, less, less or equal,
to the value of the string on the right converted to a
``real''.  </P
></LI
></UL
>&#13;</P
></DIV
><DIV
CLASS="SECT5"
><HR><H6
CLASS="SECT5"
><A
NAME="AEN676"
>6.4.1.1.5. Perl Compatible Regular Expressions</A
></H6
><P
>The operators ``=~'' and ``!~'' allow you to match a String
with a perl compatible regular expressions, also known as 
PCRE.</P
><P
>mod-xslt2 makes use of ``libpcre'' to parse and apply those
expressions. The complete reference of those regular expressions
can thus be found in perlre(1) on any unix system with perl installed, 
while a quick tutor and introduction can be found on perlretut(1) or
perlquick(1) and on any book about perl programming.</P
><P
>In mod-xslt2, PCRE are specified by enclosing them in a ``separator'',
and by indicating one or more options after the second occurrence of the
separator. A separator may be any character beside ``\'', which can be 
used to escape the separator itself if needed in the regular expression. 
Additionally, regular expressions may be enclosed in single or double quotes, to
overcome the limits of characters a String can contain as specified
in the previous sections.</P
><P
>Keep also in mind that, as being specified in a xml attribute, any
entity must also be escaped using standard xml notation.</P
><P
>In any case, the following options may be specified:

<P
></P
><UL
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>i</I
></SPAN
> - using this option, case insensitive matching is performed</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>e</I
></SPAN
> - using this option, the ``$'' matches only the end of the string and does
not match any newline the string may contain</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>a</I
></SPAN
> - using this option, the match must be ``anchored'', which means it must match
from the beginning to the end of the string</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>s</I
></SPAN
> - using this option, the ``.'' matches also newlines </P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>x</I
></SPAN
> - using this option, spaces inside a regular expression are ignored unless
they are escaped</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>X</I
></SPAN
> - using this option, you will enable libpcre features not compatible with perl.
At time of writing, enabling this option will cause an error every time an unknown character
is escaped (prepended with a ``\'')</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>m</I
></SPAN
> - using this option, you will enable multiline matching</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>y</I
></SPAN
> - this option ``inverts the greediness of the quantifiers, so that they are not greedy by
default, bug become greedy if followed by ?'' (from pcreapi(3))</P
></LI
><LI
><P
><SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>u</I
></SPAN
> - this option causes PCRE to consider both the pattern and the string as made of UTF-8 encoded
characters</P
></LI
></UL
>

The following are all examples of valid regular expressions:

<PRE
CLASS="SCREEN"
>'/fuffa/i' - match ``fuffa'', ``Fuffa'', ``FUFFA'',
	``abfuffabc''...
'$bap$ia' - match ``bap'', ``Bap'', ...
'$a\\\$$i' - match any string containing ``a$''. In this
	case, ``$'' is escaped twice to avoid it being
	considered ``the terminator'' and to avoid any
	meaning as regular expression special character.
'&amp;amp;fuffa&amp;amp;i' - exactly like the first example,
	but using ``&amp;'' as separator</PRE
>

Note that I have always enclosed them in quotes, to avoid causing
problems to the parser.</P
></DIV
><DIV
CLASS="SECT5"
><HR><H6
CLASS="SECT5"
><A
NAME="AEN712"
>6.4.1.1.6. Examples of complete media expressions</A
></H6
><P
>&#13;<PRE
CLASS="SCREEN"
>&lt;modxslt-stylesheet ... media="fuffa" ... &gt;</PRE
>

will return false, and the stylesheet not applied.

<PRE
CLASS="SCREEN"
>&lt;modxslt-stylesheet ... media="all" ... &gt;</PRE
>

will return true, and the stylesheet applied.

<PRE
CLASS="SCREEN"
>&lt;modxslt-stylesheet ... media="screen" ... &gt;</PRE
>

will return true, and the stylesheet applied.

<PRE
CLASS="SCREEN"
>&lt;modxslt-stylesheet ... media="screen and 
  '$HEADER[User-Agent]' =~ '/msie/i'" ... &gt;</PRE
>

will return true only if the header ``User-Agent'' contains the string ``msie'' compared
using case insensitive matching.

<PRE
CLASS="SCREEN"
>&lt;modxslt-stylesheet ... 
  media="screen and 
  	  '$HEADER[User-Agent]' =~ '/msie/i' or 
          '$HEADER[User-Agent]' =~ '/Moz.*1\.0/'" 
	  ... &gt;</PRE
>

will return true if the header ``User-Agent'' contains the string ``msie'' compared
using case insensitive matching or contains the string ``Moz'' followed by any number of
any character as long as it is followed by the string ``1.0''.

<PRE
CLASS="SCREEN"
>&lt;modxslt-stylesheet ... 
  media="fuffa, screen and $GET[ignorebrowser] or 
          '$HEADER[User-Agent]' =~ '/Moz.*1\.0/'" 
	  ... &gt;</PRE
>

will return true when the xml page was called by a browser with a get
parameter ``ignorebrowser'' with any value (with something like 
http://url.of.xml.document.org/path/to/xml/document.xml?ignorebrowser=1)
or if the header ``User-Agent'' contains the string ``Moz'' followed
by ``1.0''.

<PRE
CLASS="SCREEN"
>&lt;modxslt-stylesheet ... 
  media="fuffa, screen and 
           $MODXSLT[interface] &#62;= 1 and
  	   $MODXSLT[sapi] = apache1"</PRE
>

will return true when the interface version of mod-xslt2 
is greater than or equal to 1 and when the sapi which is 
parsing the xml document is ``apache1''. This is especially
useful if your xsl stylesheet rely on some server specific
variable/feature being available.</P
><P
>Keep also in mind that you can use as many ``moxslt-stylesheet''
or ``xml-stylesheet'' as you want. In any case, the first matching
one will be used by mod-xslt2. If none applyable will be found,
a 500 error page will be returned. The rationale is that if you
want a document to be parsed (and configure mod-xslt2 to do the
parsing), the document will be either be parsed and returned back
to the browser or an error given back without disclosing of any
additional information.</P
></DIV
></DIV
><DIV
CLASS="SECT4"
><HR><H5
CLASS="SECT4"
><A
NAME="AEN723"
>6.4.1.2. href URLs</A
></H5
><P
>Well, up to now we have seen how our .xml files can specify which
xslt to be used. However, we haven't seen where the .xsl files can
be stored and how we can specify their path.</P
><DIV
CLASS="SECT5"
><HR><H6
CLASS="SECT5"
><A
NAME="AEN726"
>6.4.1.2.1. Supported URL schemes</A
></H6
><P
>At time of writing, mod-xslt2 (thanks to libxml2), can fetch xsl,
dtd or other .xml files using one of the following methods:

<P
></P
><OL
TYPE="1"
><LI
><P
>remote http URL</P
></LI
><LI
><P
>remote ftp URL</P
></LI
><LI
><P
>local file URL</P
></LI
><LI
><P
>local http URL</P
></LI
></OL
>

The first three methods are quite standard and made
available thanks to libxml2 handlers. However,
there are a few things to keep in mind:

<P
></P
><UL
><LI
><P
>a http URL <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>must</I
></SPAN
> start with ``http://''
and could contain a port number, an username
and a password, like in <TT
CLASS="FILENAME"
>http://carlo%password@www.masobit.net:7568/file.php</TT
>.</P
></LI
><LI
><P
>a ftp URL <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>must</I
></SPAN
> start with ``ftp://''
and follow the same conventions as the http URL
shown above.</P
></LI
><LI
><P
>a file URL <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>may</I
></SPAN
> start with ``file://''
or just be an absolute or relative path. If it
starts with ``file://'', ``file://'' is removed
from the URL and the remaining path is opened.
Thus, something like ``file:///file.xsl'' points
to ``file.xsl'' in the ``root'' (/) of the file system,
while ``file://file.xsl'' indicates ``file.xsl''
in the same directory of the xml file referring to
that url. Both could been given using a path like 
``/file.xsl'' or ``file.xsl'', without any preceding
``file://'' (which is stripped anyway).</P
><P
>In short, it should follow the same syntax and behavior
as indicated on rfc 1738, 1808 and 2396.</P
></LI
></UL
>

There is a fourth url scheme supported by mod-xslt2:
local://.</P
><P
>local:// behaves exactly like a local file URL,
but tells mod-xslt2 that the file should be fetched
using the http protocol. This scheme allows you
to easily use .xsl or dtd generated by cgi or
php scripts, without using a remote connection.</P
><P
>As you may notice, there are thus at least three good
reasons to use ``local://'' instead of ``http://'':

<P
></P
><UL
><LI
><P
>Before anything else, ``local://'' is like 
the ``file://'' scheme, and allows you to easily
specify urls relative to the path of the file
using the url itself. For example, if you fetch
http://www.masobit.net/fuffa/doc.xml and doc.xml
requires ``local://xslt/doc.xsl'', the file
``http://www.masobit.net/fuffa/xslt/doc.xsl'' will be
fetched using the http protocol (and thus, allowing
doc.xsl to be a php script or cgi-bin).</P
><P
>In contrast, ``local:///xslt/doc.xsl'' would refer
to ``http://www.masobit.net/xslt/doc.xsl'', much 
like ``file://''.</P
></LI
><LI
><P
>In second instance, if you use virtual domains
and you want to make use of locally generated
xsl files, you cannot reliably use the 
``http://'' scheme. As you may guess, in 
``virtual'' environments ``http://localhost/xslt/doc.xsl'' 
would not be necessarily the same as 
``http://www.masobit.net/xslt/doc.xsl'', and there
would be no way to specify a relative url if 
``local://'' was not available.</P
></LI
><LI
><P
>Instead of using an outgoing connection, when a ``local://''
url is specified a ``subrequest'' is made, allowing

<P
></P
><UL
><LI
><P
>faster retrieval of generated documents</P
></LI
><LI
><P
>easy detection of loops  (more about
loops will be discussed later)</P
></LI
><LI
><P
>to avoid a deadlock that may halt mod-xslt2
(and that halts any mod-xslt2 I have seen on 
the internet) under very high loads (which a
malicious user may use to cause a denial of service)</P
></LI
></UL
>&#13;</P
></LI
></UL
>&#13;</P
></DIV
></DIV
><DIV
CLASS="SECT4"
><HR><H5
CLASS="SECT4"
><A
NAME="AEN767"
>6.4.1.3. HTTP glinces</A
></H5
><P
>If you use http urls, either for external DTDs or for xsl stylesheets,
watch out for a small problem it may arise: libxml2, by default, when
fetching a remote document, does not check for the http status of the web 
server. The result is that, libxml2, will try to parse everything that
will be returned back to the browser, even a 404 or 500 error page.</P
><P
>Some believe this behavior is correct, others believe error pages
should be considered exactly like a file system error. However, independently
from what I think, this behavior leads to strange results when parsing
documents: for example, if a DTD is missing on the local file system,
the problem is ignored, but if it is missing from a remote url, the 404
page is parsed as the looked up DTD, and a fatal error is produced,
telling the DTD is invalid. Additionally, in your error log you would
see wierd errors telling you about invalid lines in DTDs you know 
nothing about and you cannot find anywhere in the file system.</P
><P
>So, beware, if you find strange errors regarding DTDs or xslt you 
never wrote, verify they are not the 404 or 500 error pages
returned back by a remote server.</P
><P
>There's one more thing to say: I personally don't like this behavior.
I tryed to get rid of it in several ways, but the only way out I found
was either rewrite the http client (or include my own with mod-xslt2) or 
patch libxml2 library.</P
><P
>The first solution didn't seem quite realistic to me, so, in the ``/patches''
directory of the mod-xslt2 tarball, you'll find two patches:

<P
></P
><UL
><LI
><P
>The first one makes libxml2 verify the error status of the remote
web server, and return an error if it is not a 200 or 3xx (in which
case the page the client has been redirected to will be fetched)</P
></LI
><LI
><P
>The second one makes libxml2 export some private data allowing
anybody making use of it to freely choose what to do in case
of errors</P
></LI
></UL
>

Personally, I believe the first patch may break things up. On your system,
you may have applications that rely on libxml2 parsing error pages (I personally
believe those applications should be considered broken anyway). The
second patch, instead, should not break anything.</P
><DIV
CLASS="SECT5"
><HR><H6
CLASS="SECT5"
><A
NAME="AEN779"
>6.4.1.3.1. URL, media and type substitutions</A
></H6
><P
>Additionally, any URL specified in a ``href'' attribute or
the value of the ``type'' and ``media'' attribute in
a &lt;xml-stylesheet or &lt;modxslt-stylesheet may contain
any mod-xslt2 expression , that will be replaced the
first time the expression itself is used.</P
><P
>As an example, you may specify something like:

<PRE
CLASS="SCREEN"
>&lt;?xml-stylesheet type="text/xsl" 
  href="http://www.mbit.net/xslt/faq.php?
    lang=$GET[lang]&amp;agent=$HEADER[User-Agent]"</PRE
>

This is useful to pass over parameters to php or cgi scripts. As you
may already have noted, any generated xsl stylesheet is able to access
to mod-xslt2 variables, but the cgi or php script itself does not have
any access to them, unless you pass them over as get parameters.</P
><P
>Right now, POST requests are not supported and will never be unless
somebody decides it worth and either works on it or bagges me to do 
so.</P
><P
>Note also that URL should be correctly encoded by replacing xml
entities and by replacing any dangerous character with the corresponding
``%'' value.</P
></DIV
><DIV
CLASS="SECT5"
><HR><H6
CLASS="SECT5"
><A
NAME="AEN786"
>6.4.1.3.2. Returning raw xml back to the browser</A
></H6
><P
>Using the processing instruction ``xml-stylesheet''
to select a stylesheet to be used, you must
specify the ``href'' of the stylesheet to be used.
Failure of doing so will result in an error be 
outputted in your logs. However, if you use
``modxslt-stylesheet'', you can omit the ``href''
of the stylesheet to be used. In this case, the
xml will be returned back to the browser without
further processing.</P
><P
>This is quite useful if you know a particular browser
is able to correctly parse your xml files: in this
case, you can use a ``media expression'' to match
the browser, and specify no href for the xml to
be returned back raw to the client, with something
like:

<PRE
CLASS="SCREEN"
>[...]
&lt;modxslt-stylesheet 
  type="text/xsl"
  media="screen and 
    '$HEADER[User-Agent]' =~ '@Gecko.*1\.4@'"
  alternate="no" title="For Mozilla web browser" 
  charset="ISO-8859-1" ?&gt;

&lt;modxslt-stylesheet 
  type="text/xsl"
  href="local://xslt/links.xsl"
  media="screen and 
    '$HEADER[User-Agent]' =~ '@Links@'"
  alternate="no" title="For Links web browser" 
  charset="ISO-8859-1" ?&gt;

&lt;xml-stylesheet
  type="text/xsl"
  href="local://xslt/any.xsl"
  media="screen"
  alternate="no" title="For any other web browser"
  charset="ISO-8859-1" ?&gt;
[...]</PRE
>

In the example above, the xml file would be returned
raw if the request was made by ``mozilla'', would be
parsed using ``xslt/links.xsl'' if the request was made
by ``Links'' while it would be parsed using ``any.xsl''
if the request was made by any other web browser.</P
><P
>If ``mozilla'' was used, the raw document would be then
parsed by mozilla itself, that would ignore any 
``modxslt-stylesheet'' and use as a stylesheet 
``local://any.xsl''. However, mozilla itself wouldn't
understand ``local://'' urls and return an error. Thus, 
in any ``raw'' document returned by mod-xslt2, ``local://''
urls are replaced by standard ``http://'' urls
pointing back to the virtual domain that was used
to issue the request, allowing mozilla to parse
the document without problems. </P
><P
>Additionally, any mod-xslt2 variable used in &lt;xml-stylesheet
processing instruction is replaced before returning back
the raw xml document to the browser.</P
><P
>This feature will be especially useful as more browsers
will correctly support xml and xsl transformations.</P
><P
>Note, however, that variables used in &lt;modxslt-stylesheet 
pi are not replaced: the main reason not to parse them
is that expressions may loose their meaning if variables are
replaced (... screen and 'Mozilla/5.0 Gecho/20031010 Debian/1.4-6' =~ '@Gecko/.*1\.4@' 
??, doesn't seem too smart), and that a browser is able
to understand those PI it should be given all the needed
informations to perform expression evaluation by itself.</P
></DIV
></DIV
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN795"
>6.5. Using external DTDs</A
></H3
><P
>Some believe DTDs are useless to parse xml documents or to
generate http output. However, as you probably know, 
DTDs may be used to provide defaults for certain tags
or provide the definition of entities used by your xml 
document.</P
><P
>However, DTDs are not always useful and parsing one additional 
document may be not a bearable overhead.</P
><P
>The approach used by mod-xslt2 is to parse externa DTDs only
if the document is declared not to be standalone. Thus,
the standalone attribute in your xml declaration is not
ignored:

<PRE
CLASS="SCREEN"
>&lt;?xml version="1.0" encoding="ISO-8859-1" 
	standalone="yes" ?&gt;</PRE
>

tells mod-xslt2 not to load external DTDs, while:

<PRE
CLASS="SCREEN"
>&lt;?xml version="1.0" encoding="ISO-8859-1" 
	standalone="no" ?&gt;</PRE
>

tells mod-xslt2 your xml file needs them. Even if you tell mod-xslt2
to make use of DTDs, just an error will be printed if they are
missing (unless they are fetched using the http protocol, look 
to the section ``HTTP Glinces'').</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN802"
>6.6. Testing xml files and stylesheets from the command line</A
></H3
><P
>Before putting a xml page or newly created php script on your web 
server you may want to test the generated output statically on
your local machine.</P
><P
>Since it may not always be possible to use a web server to verify
them, you may be interested in some command line utilities you
may found useful.</P
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN806"
>6.6.1. xsltproc</A
></H4
><P
>xsltproc is a tool provided in the libxslt package which can
be used to process xml files from the command line. As
being provided by libxslt, however, it does not support  
mod-xslt2 extensions and uses different error handling
routines.</P
><P
>To use it, you just need to type ``xsltproc file_to_parse.xml''.
The output will be printed on stdout. In case of errors, they
will be printed on stderr.</P
><P
>xsltproc may be useful mainly for two purposes: you can see
what a standard browser (that does not support mod-xslt2 extensions)
would do with your xml documents, and you can profile the
parsing times. xsltproc provides the ``--timing'' parameter
which allows you to know which xslt instructions required
the greatest amount of time to generate the output document,
with something like ``xsltproc --timing file_to_parse.xml''.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN811"
>6.6.2. modxslt-parse</A
></H4
><P
>modxslt-parse looks quite similare to xsltproc. The main 
difference is that modxslt-parse supports all mod-xslt2
extensions and that does not support any command line
parameter, beside the name of the file to parse (output
is sent to standard output). It is quite useful to 
verify a particular .xml file off-line from your command
line. You can use it by simply typing something like:

<PRE
CLASS="SCREEN"
>modxslt-parse file.xml</PRE
>

from your command line. Output will be sent to stdout,
while errors to stderr. Headers set will be discarded.
It internally uses exactly the same engine as mod-xslt2.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN815"
>6.6.3. rxp</A
></H4
><P
>``rxp'' is a tool provided in the rxp package on
http://www.cogsci.ed.ac.uk/~richard/rxp.html.</P
><P
>It can be used to verify validity of xml files
or well-formedness. It should be used to verify the
output of your scripts or the validity of your
xml files before putting them on line.</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN819"
>6.7. Other tools provided</A
></H3
><DIV
CLASS="SECT3"
><H4
CLASS="SECT3"
><A
NAME="AEN821"
>6.7.1. modxslt-perror</A
></H4
><P
>Since strerror is not thread safe on many systems, 
it cannot be used to translate ``errno'' error codes
in to more readeable (for human beings) strings.</P
><P
>If you see strange ``errno: x'' error codes in your
logs, just use something like:

<PRE
CLASS="SCREEN"
>modxslt-perror x</PRE
>

to know which error verifyed during parsing. The value
of ``x'' is really system dependent, so, I cannot tell
you beforehand what the ``x'' errno error means on your
systme, unless you run modxslt-perror (which asks your
operative system what it means).</P
></DIV
><DIV
CLASS="SECT3"
><HR><H4
CLASS="SECT3"
><A
NAME="AEN826"
>6.7.2. modxslt-config</A
></H4
><P
>modxslt-config can be used to query mod-xslt2 configure
and installation parameters. It is usually useful only
if you are encountering problems in using mod-xslt2 (problems
like inability to load libraries, linking failures...)
or if you are writing code for mod-xslt2 (to know the build
parameters to be used).</P
><P
>It can also be used to verify if mod-xslt2 is installed
on the system.</P
></DIV
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="AEN830"
>7. Security considerations</A
></H2
><P
>As any code that runs with the same privileges as your web 
server, there are some dangers you should be aware of and
some considerations that should be made.</P
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN833"
>7.1. Variables substitution</A
></H3
><P
>In the previous sections, you have seen you can use 
mod-xslt2 variables to build up hrefs to be used as the
url of the xslt to be used.</P
><P
>Keep in mind, however, that GET and HEADER variables
were given to you by the browser and that their values
cannot be trusted.</P
><P
>As an example, you could specify something like:

<PRE
CLASS="SCREEN"
>&lt;modxslt-stylesheet ... href="/data/xslt/$GET[lang].xsl" ...</PRE
>

But what happens here if ``$GET[lang]'' contains characters
like ``../../../etc/passwd''? We cannot tell for sure. For sure, mod-xslt2
would try to open a file like ``/etc/passwd'' and use it as 
a stylesheet. Obviously, this wouldn't be considered a valid
stylesheet and a 500 error returned back to the client. But,
keep in mind that mod-xslt2 both in apache 1.3 and 2.x runs
with the same privileges as the web server itself, and would
thus be able to read others .xsl files if you specify
variables like that in the href of the stylesheet.</P
><P
>Unless you have very good reasons to do so, I would suggest
you to always use ``local://'' or ``http://'' urls when you
need to make use of untrusted variables, and specify those
variables as arguments to cgi or php scripts, which, in turn,
may verify the genuinity of untrusted variables. The
example above, could be made more ``security aware'' by
using something like:
<PRE
CLASS="SCREEN"
>&lt;modxslt-stylesheet ... 
    href="local:///getxsllang.php?lang=$GET[lang]" ...</PRE
>&#13;</P
><P
>Another solution would be to use one single stylesheet, and
verify from there the validity of variables by using standard 
``xsl:...'' constructs and act accordingly.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN842"
>7.2. Avoiding deadlocks under heavy loads</A
></H3
><P
>Ok, let's say you have a .xml file that needs a .xsl file
to be fetched from a remote url in order to be correctly parsed.</P
><P
>Let's say you are using apache 1.3 and that a browser issues
a request to get the content of that file. Now, apache would 
receive the request, mod-xslt2 would be called to handle
that request and a connection be open to fetch the remote
stylesheet. Now, beshide the risks involved with letting your 
customers upload ``static'' pages able to force your apache
to make outgoing connections, if, for any reason, that connection
comes back to your site, your apache is at risk: if we set
up apache to handle at most 100 requests at a time 
(100 children) and we get 100 requests for that page 
<SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>at the same time</I
></SPAN
>, mod-xslt2 
will not be able to connect to the remote host to fetch
the stylesheet (no more children available), and will
wait for an apache child to become available. However,
no apache child will become available until at least
one mod-xslt2 is done, and no mod-xslt2 will be done until
at least one child becomes available or the tcp connection
expires (after a long time).</P
><P
>Thus, by having .xml files that use .xsl stylesheet through
http urls that in a way or another point back to the
same apache server, we are at risk. Somebody could easily
DoS us by simply running something like: 
``while :; do wget http://remote.url/file.xml &amp; done;''</P
><P
>  Most of the other apache modules (not limited to .xml parsing
  modules) out there on the internet simply don't worry about this
  kind of problem.</P
><P
>However, mod-xslt tries as hard as it can to avoid
this kind of deadlock: any local:// request is handled
using a sub request, which doesn't use any other apache
process, exactly like http:// connections that resolve to 
any of the addresses you set up apache to listen on.</P
><P
>Beware, however, that if you have NAT boxes or redirectors, mod-xslt2
will not be able to distinguish between local and 
remote urls and won't be able to avoid this kind of deadlock.</P
><P
>Keep also in mind that if mod-xslt2 does not know
the ip addresses your server is listening on, it won't
be able to help you out neither. So, your OS must
support the IOCTL needed to get all the ip addresses
it is listening on or you must explicitly list them
in the apache ``Listen'' directive (instead of using ``*'').</P
><P
>Experimental code to autodetect this sort of condition
is under testing, but it may introduce security risks.
If you want to know more about it, please contact
one of the authors.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H3
CLASS="SECT2"
><A
NAME="AEN853"
>7.3. Avoiding remote URLs in substitutions</A
></H3
><P
>If I were you, I'd also try to avoid as much as possible
using variables when indicating path for:

<P
></P
><UL
><LI
><P
>other files to be included</P
></LI
><LI
><P
>dtds or xslt to be used</P
></LI
></UL
>

or, at least, I'd try to explicitly specify the url scheme
to be used. For example, if I'd really need to do something 
like:

<PRE
CLASS="SCREEN"
>&lt;?modxslt-stylesheet ... href="$GET[theme].xsl" ... ?&gt;</PRE
>

I'd change ``$GET[theme].xsl'' either in ``file://$GET[theme].xsl'',
``http://hostname/dir/$GET[theme].xsl'' or ``local:///path/$GET[theme].xsl''.
The first one in facts is quite dangerous:

<P
></P
><UL
><LI
><P
>an attacker could use your server for a DoS againsta somebody
else (by specifying the http:// url of somebody else)</P
></LI
><LI
><P
>could specify urls to gather data about remote hosts</P
></LI
><LI
><P
>could specify urls to very big files and make lot of requests
and make you eat up all your bandwidth</P
></LI
></UL
>

By always specifying the url scheme and host explicitly, we would limitate
the range of action of an attacker significantly.</P
><P
>This is just another issue about using untrusted variables.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H2
CLASS="SECT1"
><A
NAME="AEN870"
>8. Reporting BUGS / Helping out the project</A
></H2
><P
>  To report a bug, just drop a mail to one of the mod-xslt mailing
  lists. This version of mod-xslt is quite new, and has been used
  on few platforms and operative systems... so, it is very important
  to us to get bug reports and users feedback, so please make sure,
  if you find a bug to drop us a mail.</P
><P
>  If you do so, please include as much information as you have: something
  like ``it doesn't work'' does not help us much in fixing the problem. What
  does not work? Can you configure it? Compile it? Install it? How did you
  configure Apache? How can you say it does not work? Are you trying to access
  a document on your web server? Which document? Under which folder? What kind
  of document is that? Is it a POST request or a GET request? Is it a static
  document or a dynamic one? Does it use DTDs? How is the xslt referenced?
  What do the logs say? ...</P
><P
>  Sometimes, it may be useful to have the .xml you used at hand, some other
  times it may be useful to get a dump of your client connection. In the
  first case, just attach your xml file. In the second, run something like
  ``tcpdump -nei eth0 -s 8192 -w ./file.dump host yourclientipaddress and port 80''
  to get a trace in ``file.dump''.</P
><P
>  If you want to help mod-xslt development, just drop us a mail in one of
  the mailing lists. We are always happy to get new hands at work. </P
></DIV
></DIV
></BODY
></HTML
>
