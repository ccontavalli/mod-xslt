#!/bin/bash

# Inserts checksums in a changelog-generate generate
# changelog entry

. tools/include/config || {
  echo "must be run from mod-xslt source top level directory" 1>&2
  exit 1
}

test -n "$library_ymd" || {
  echo 1>&2 "no ymd provided"
  exit 1
}

test -f "${dir_repository}/${library_ymd}/modxslt-${library_ymd}.tar.gz" || {
  echo 1>&2 "must first create package"
  exit 1
}

test -n "$library_file" || {
  echo 1>&2 "no library_file provided"
  exit 1;
}

pid="$$"
(
  sed "/<!-- %CHECKSUMS-${library_ymd}% -->/q" "$dir_changelog"/"$library_file"

  cat <<EOF
        <checksum type="md5">`md5sum ${dir_repository}/${library_ymd}/modxslt-${library_ymd}.tar.gz |cut -d' ' -f1`</checksum>
EOF
  test ! -f "${dir_repository}/${library_ymd}/modxslt-${library_ymd}.tar.gz.asc" || \
    echo "        <checksum type=\"pgp\">modxslt-${library_ymd}.tar.gz.asc</checksum>"
  sed -n "/<!-- %CHECKSUMS-${library_ymd}% -->/,\$p" "$dir_changelog"/"$library_file" | tail -n+2
) > "$dir_changelog"/"$library_file"."$pid"

mv "$dir_changelog"/"$library_file"."$pid" "$dir_changelog"/"$library_file"
